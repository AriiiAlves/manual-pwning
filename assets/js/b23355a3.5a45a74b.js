"use strict";(globalThis.webpackChunkmanual_pwning_docs=globalThis.webpackChunkmanual_pwning_docs||[]).push([[1271],{7441(r,n,e){e.r(n),e.d(n,{assets:()=>t,contentTitle:()=>d,default:()=>m,frontMatter:()=>o,metadata:()=>a,toc:()=>l});const a=JSON.parse('{"id":"pwning/z3","title":"Z3 & Symbolic Execution (angr)","description":"Z3 - Solucionador de condi\xe7\xf5es","source":"@site/docs/pwning/7-z3.md","sourceDirName":"pwning","slug":"/pwning/z3","permalink":"/manual-pwning/docs/pwning/z3","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":7,"frontMatter":{"title":"Z3 & Symbolic Execution (angr)"},"sidebar":"tutorialSidebar","previous":{"title":"Bad Seed","permalink":"/manual-pwning/docs/pwning/bad-seed"},"next":{"title":"Fast Food","permalink":"/manual-pwning/docs/fast-food/beginning"}}');var s=e(4848),i=e(8453);const o={title:"Z3 & Symbolic Execution (angr)"},d=void 0,t={},l=[{value:"Z3 - Solucionador de condi\xe7\xf5es",id:"z3---solucionador-de-condi\xe7\xf5es",level:2},{value:"Exemplo",id:"exemplo",level:3},{value:"Z3 CheatSheet",id:"z3-cheatsheet",level:3},{value:"Vari\xe1veis simples (inteiros, booleanos, reais)",id:"vari\xe1veis-simples-inteiros-booleanos-reais",level:4},{value:"Strings",id:"strings",level:4},{value:"Arrays",id:"arrays",level:4},{value:"Arrays de strings",id:"arrays-de-strings",level:4},{value:"Symbolic Execution",id:"symbolic-execution",level:2},{value:"Como funciona?",id:"como-funciona",level:3},{value:"Angr",id:"angr",level:2},{value:"Como usar",id:"como-usar",level:3},{value:"Carregando um bin\xe1rio",id:"carregando-um-bin\xe1rio",level:4},{value:"Criando vari\xe1veis simb\xf3licas",id:"criando-vari\xe1veis-simb\xf3licas",level:4},{value:"Criando um estado inicial",id:"criando-um-estado-inicial",level:4},{value:"Capturando coisas impressas",id:"capturando-coisas-impressas",level:4},{value:"Encontrando fun\xe7\xf5es",id:"encontrando-fun\xe7\xf5es",level:4},{value:"Constraints (Importante)",id:"constraints-importante",level:4},{value:"Constraints para strings",id:"constraints-para-strings",level:5},{value:"Constraints para arrays",id:"constraints-para-arrays",level:5},{value:"Hook de fun\xe7\xf5es",id:"hook-de-fun\xe7\xf5es",level:4},{value:"Explora\xe7\xe3o dirigida por endere\xe7o de mem\xf3ria",id:"explora\xe7\xe3o-dirigida-por-endere\xe7o-de-mem\xf3ria",level:4},{value:"Erros e problemas comuns",id:"erros-e-problemas-comuns",level:4},{value:"Exemplo - Encontrando senha",id:"exemplo---encontrando-senha",level:4},{value:"Exemplo - Minimalista",id:"exemplo---minimalista",level:4}];function c(r){const n={blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",h5:"h5",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...r.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.h2,{id:"z3---solucionador-de-condi\xe7\xf5es",children:"Z3 - Solucionador de condi\xe7\xf5es"}),"\n",(0,s.jsxs)(n.p,{children:["Z3 \xe9 o Solver SMT (Satisfiability Modulo Theories) desenvolvido para Microsoft. \xc9 um solver de restri\xe7\xf5es que pode ",(0,s.jsx)(n.strong,{children:"resolver equa\xe7\xf5es e l\xf3gica simb\xf3lica"}),". \xc9 usado para ",(0,s.jsx)(n.strong,{children:"encontrar valores que satisfa\xe7am condi\xe7\xf5es espec\xedficas"}),"."]}),"\n",(0,s.jsxs)(n.p,{children:["Para instalar: ",(0,s.jsx)(n.code,{children:"pip install z3-solver"})]}),"\n",(0,s.jsx)(n.p,{children:"Por exemplo, se temos as restri\xe7\xf5es:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"x + y = 10\r\nx > 0\r\ny > x\n"})}),"\n",(0,s.jsxs)(n.p,{children:["damos elas ao Z3 e ele retorna ",(0,s.jsx)(n.code,{children:"x = 4"}),", ",(0,s.jsx)(n.code,{children:"y = 6"}),". (uma das poss\xedveis solu\xe7\xf5es)"]}),"\n",(0,s.jsx)(n.p,{children:"Em pwning, o Z3 pode ser usado para resolver condi\xe7\xf5es complexas de um programa, como:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Encontrar a entrada que atinge um certo endere\xe7o"}),"\n",(0,s.jsx)(n.li,{children:"Resolver equa\xe7\xf5es de overflow"}),"\n",(0,s.jsx)(n.li,{children:"Quebrar prote\xe7\xf5es como stack canaries se puderem ser deduzidos"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Por\xe9m n\xf3s precisamos analisar as condi\xe7\xf5es no c\xf3digo para dar ao z3. Uma vez analisadas as condi\xe7\xf5es, ele faz o resto."}),"\n",(0,s.jsx)(n.h3,{id:"exemplo",children:"Exemplo"}),"\n",(0,s.jsx)(n.p,{children:"Suponha que o programa exija um input com as seguintes condi\xe7\xf5es:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"x + y == 0xdeadbeef"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"x > 0x1000"})}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"y & 0xff == 0x42"})," (& \xe9 uma opera\xe7\xe3o bit a bit AND)"]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Vamos usar o Z3 solver para achar x e y:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-py",children:"from z3 import *\r\n\r\nx = BitVec('x', 32)  # vari\xe1vel de 32 bits\r\ny = BitVec('y', 32)\r\n\r\ns = Solver()\r\ns.add(x + y == 0xdeadbeef)\r\ns.add(x > 0x1000)\r\ns.add(y & 0xff == 0x42)\r\n\r\nif s.check() == sat:\r\n    m = s.model()\r\n    print(hex(m[x].as_long()), hex(m[y].as_long()))\r\nelif s.check() == unsat:\r\n    print(\"N\xe3o \xe9 poss\xedvel resolver\")\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Isto nos retorna ",(0,s.jsx)(n.code,{children:"0x1c8f3fad 0xc21e7f42"}),". Se verificarmos em uma calculadora, ",(0,s.jsx)(n.code,{children:"0x1c8f3fad + 0xc21e7f42 = 0xdeadbeef"}),"."]}),"\n",(0,s.jsx)(n.h3,{id:"z3-cheatsheet",children:"Z3 CheatSheet"}),"\n",(0,s.jsx)(n.h4,{id:"vari\xe1veis-simples-inteiros-booleanos-reais",children:"Vari\xe1veis simples (inteiros, booleanos, reais)"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-py",children:"from z3 import *\r\n\r\n# Inteiros\r\nx = Int('x')\r\ny = Int('y')\r\n\r\n# Booleanas\r\np = Bool('p')\r\nq = Bool('q')\r\n\r\n# Reais\r\na = Real('a')\r\nb = Real('b')\r\n\r\n# Exemplo: resolver x + y = 10, x > y\r\ns = Solver()\r\ns.add(x + y == 10)\r\ns.add(x > y)\r\n\r\nif s.check() == sat:\r\n    m = s.model()\r\n    print(f\"x = {m[x]}, y = {m[y]}\")\n"})}),"\n",(0,s.jsx)(n.h4,{id:"strings",children:"Strings"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-py",children:'from z3 import *\r\n\r\n# Criar vari\xe1veis string\r\ns1 = String(\'s1\')\r\ns2 = String(\'s2\')\r\n\r\n# Criar solver com teoria de strings\r\ns = Solver()\r\n\r\n# Opera\xe7\xf5es com strings\r\ns.add(Length(s1) == 5)                    # Comprimento\r\ns.add(Concat(s1, s2) == "HelloWorld")     # Concatena\xe7\xe3o\r\ns.add(Contains(s1, "ell"))                # Cont\xe9m substring\r\ns.add(PrefixOf("He", s1))                 # \xc9 prefixo\r\ns.add(SuffixOf("lo", s1))                 # \xc9 sufixo\r\ns.add(s1 == "Hello")                      # Igualdade\r\n\r\n# Extrair substring\r\ns.add(SubString(s1, 1, 3) == "el")\r\n\r\n# \xcdndice de caracter\r\ns.add(IndexOf(s1, "l", 0) == 2)           # Primeira ocorr\xeancia de \'l\'\r\n\r\nif s.check() == sat:\r\n    print(s.model())\n'})}),"\n",(0,s.jsx)(n.h4,{id:"arrays",children:"Arrays"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-py",children:"from z3 import *\r\n\r\n# Declara\xe7\xe3o de array: ArraySort(dom\xednio (\xedndice), contradom\xednio (conte\xfado))\r\nA = Array('A', IntSort(), IntSort()) # A = [0,1,2,3] (exemplo)\r\nB = Array('B', IntSort(), BoolSort()) # A[0] = False, A[1] = True (exemplo)\r\n\r\ns = Solver()\r\n\r\n# Opera\xe7\xf5es b\xe1sicas\r\n# 1. Store: modificar um elemento\r\nA1 = Store(A, 0, 10)  # A[0] = 10\r\n\r\n# 2. Select: acessar um elemento\r\ns.add(Select(A, 0) == 10)\r\ns.add(Select(A, 1) == 20)\r\n\r\n# 3. Exemplo mais complexo\r\nx = Int('x')\r\ns.add(x >= 0, x < 5)\r\ns.add(Select(A, x) == 100)\r\n\r\n# Array constante\r\n# Criar array onde todos os elementos s\xe3o 0\r\nconst_array = K(IntSort(), 0)\r\ns.add(Select(const_array, 5) == 0)\r\n\r\nif s.check() == sat:\r\n    m = s.model()\r\n    print(f\"Modelo: {m}\")\n"})}),"\n",(0,s.jsx)(n.h4,{id:"arrays-de-strings",children:"Arrays de strings"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-py",children:'from z3 import *\r\n\r\n# Array de \xedndices inteiros para strings\r\nstring_array = Array(\'string_array\', IntSort(), StringSort())\r\n\r\ns = Solver()\r\n\r\n# Definir valores\r\ns.add(Select(string_array, 0) == "hello")\r\ns.add(Select(string_array, 1) == "world")\r\n\r\n# Cria c\xf3pia do array com modifica\xe7\xe3o: string_array[2] = "z3"\r\nnew_array = Store(string_array, 2, "z3")\r\n\r\nif s.check() == sat:\r\n    m = s.model()\r\n    print(f"array[0] = {m.evaluate(Select(string_array, 0))}")\n'})}),"\n",(0,s.jsx)(n.h2,{id:"symbolic-execution",children:"Symbolic Execution"}),"\n",(0,s.jsxs)(n.p,{children:["Symbolic Execution \xe9 uma t\xe9cnica de an\xe1lise onde as vari\xe1veis possuem valores simb\xf3licos (n\xe3o valores concretos como ",(0,s.jsx)(n.code,{children:"int"}),", ",(0,s.jsx)(n.code,{children:"float"}),", ",(0,s.jsx)(n.code,{children:"str"}),", etc). Em vez de testar com entradas espec\xedficas, as entradas s\xe3o tratadas como vari\xe1veis simb\xf3licas e s\xe3o rastreadas restri\xe7\xf5es (constraints) sobre esses s\xedmbolos \xe0 medida que o programa \xe9 executado."]}),"\n",(0,s.jsx)(n.p,{children:"Imagine que voc\xea pode testar TODAS as entradas poss\xedveis de um programa de uma s\xf3 vez, sem precisar execut\xe1-lo fisicamente milh\xf5es de vezes. Isso \xe9 an\xe1lise simb\xf3lica. A cada IF/WHILE/FOR, um novo estado \xe9 gerado e a sa\xedda gerada \xe9 analisada."}),"\n",(0,s.jsx)(n.p,{children:"Por exemplo, temos um programa que diz se um n\xfamero \xe9 positivo:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-py",children:'if x > 0:\r\n    print("Positivo")\r\nelse:\r\n    print("N\xe3o positivo")\n'})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Execu\xe7\xe3o normal"}),": Testamos com ",(0,s.jsx)(n.code,{children:"x = 5"})," -> Resultado: Positivo"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Execu\xe7\xe3o simb\xf3lica"}),": Usamos x = \u03b1 (s\xedmbolo). Quando chegamos no ",(0,s.jsx)(n.code,{children:"if"}),", criamos dois caminhos para a condi\xe7\xe3o if($\\alpha > 0$):","\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["Estado ",(0,s.jsx)(n.code,{children:"true"}),': $\\alpha > 0\\rightarrow$ print: "Positivo"']}),"\n",(0,s.jsxs)(n.li,{children:["Estado ",(0,s.jsx)(n.code,{children:"false"}),': $\\alpha \\leq 0\\rightarrow$ print: "N\xe3o positivo"']}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"como-funciona",children:"Como funciona?"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Vari\xe1veis simb\xf3licas"})," - As entradas do programa s\xe3o representadas por ",(0,s.jsx)(n.strong,{children:"s\xedmbolos"})," (X, Y)."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Valores de vari\xe1veis"})," - ",(0,s.jsx)(n.strong,{children:"Os valores das vari\xe1veis ficam em fun\xe7\xe3o desses s\xedmbolos"}),", como uma equa\xe7\xe3o (X + 2)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Path Constraints"})," - S\xe3o definidas as condi\xe7\xf5es sobre s\xedmbolos para alcan\xe7ar uma parte do c\xf3digo (",(0,s.jsx)(n.code,{children:">"}),", ",(0,s.jsx)(n.code,{children:"<"}),", ",(0,s.jsx)(n.code,{children:"=="}),", etc)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Explora\xe7\xe3o de caminhos"})," - Em cada branch (if, loop, etc), divide a execu\xe7\xe3o em m\xfaltiplos caminhos, adicionando a condi\xe7\xe3o ao conjunto de constraints"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Solu\xe7\xe3o com SAT/SMT solver"})," - Depois que encontramos todas as rela\xe7\xf5es e queremos chegar a um caminho espec\xedfico, agora \xe9 s\xf3 usar um solver para encontrar valores que satisfa\xe7am as constraints."]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"angr",children:"Angr"}),"\n",(0,s.jsx)(n.p,{children:"Angr \xe9 um framework de an\xe1lise de bin\xe1rios que implementa Symbolic execution para explorar m\xfaltiplos caminhos. Usa SMT solvers (como z3) internamente."}),"\n",(0,s.jsxs)(n.p,{children:["Para instalar: ",(0,s.jsx)(n.code,{children:"pip install angr"})]}),"\n",(0,s.jsxs)(n.p,{children:["O fluxo de uso b\xe1sico do ",(0,s.jsx)(n.code,{children:"angr"})," \xe9:"]}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["Carregar bin\xe1rio \u2192 ",(0,s.jsx)(n.code,{children:"angr.Project()"})]}),"\n",(0,s.jsxs)(n.li,{children:["Criar vari\xe1vel \u2192 ",(0,s.jsx)(n.code,{children:"claripy.BVS()"})]}),"\n",(0,s.jsxs)(n.li,{children:["Criar estado \u2192 ",(0,s.jsx)(n.code,{children:"factory.entry_state()"})]}),"\n",(0,s.jsxs)(n.li,{children:["Criar manager \u2192 ",(0,s.jsx)(n.code,{children:"factory.simulation_manager()"})]}),"\n",(0,s.jsxs)(n.li,{children:["Definir condi\xe7\xe3o \u2192 ",(0,s.jsx)(n.code,{children:"fun\xe7\xe3o"})," que verifica output"]}),"\n",(0,s.jsxs)(n.li,{children:["Explorar \u2192 ",(0,s.jsx)(n.code,{children:"sm.explore(find=condicao)"})]}),"\n",(0,s.jsxs)(n.li,{children:["Extrair solu\xe7\xe3o \u2192 ",(0,s.jsx)(n.code,{children:"state.solver.eval()"})]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"como-usar",children:"Como usar"}),"\n",(0,s.jsx)(n.h4,{id:"carregando-um-bin\xe1rio",children:"Carregando um bin\xe1rio"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-py",children:'import angr\r\n\r\n# 1. Carregar um programa (bin\xe1rio compilado)\r\n# auto_load_libs=False \u2192 N\xe3o carrega bibliotecas dinamicamente (mais r\xe1pido)\r\nproj = angr.Project(\'./meu_programa\', auto_load_libs=False)\r\n\r\n# Informa\xe7\xf5es b\xe1sicas do projeto\r\nprint(f"Arquitetura: {proj.arch}")           # Ex: AMD64, x86\r\nprint(f"Entry point: {hex(proj.entry)}")    # Onde o programa come\xe7a\r\nprint(f"Arquivo: {proj.filename}")\n'})}),"\n",(0,s.jsx)(n.h4,{id:"criando-vari\xe1veis-simb\xf3licas",children:"Criando vari\xe1veis simb\xf3licas"}),"\n",(0,s.jsx)(n.p,{children:"Obs: Claripy \xe9 o que permite utilizar vari\xe1veis simb\xf3licas. \xc9 a camada intermedi\xe1ria do angr par aexpress\xf5es simb\xf3licas."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-py",children:"import claripy  # Parte do angr para criar vari\xe1veis simb\xf3licas\r\n\r\n# 2.1 Criando um N\xdaMERO simb\xf3lico (32 bits = int padr\xe3o)\r\nnumero = claripy.BVS('numero', 32)  # BVS = Bit Vector Symbolic\r\n# 'numero' \u2192 nome da vari\xe1vel (para debug)\r\n# 32 \u2192 tamanho em bits (32 bits = 4 bytes = int)\r\n\r\n# 2.2 Criando uma STRING simb\xf3lica\r\nsenha = claripy.BVS('senha', 8 * 10)  # 10 caracteres * 8 bits cada\r\n# Isso cria uma sequ\xeancia de 10 bytes (80 bits)\r\n\r\n# 2.3 Criando um ARRAY simb\xf3lico\r\n# Array de 5 inteiros (5 * 32 bits)\r\narray = claripy.BVS('array', 32 * 5)\r\n# Ou como lista de vari\xe1veis individuais\r\narray_list = [claripy.BVS(f'array_{i}', 32) for i in range(5)]\n"})}),"\n",(0,s.jsx)(n.h4,{id:"criando-um-estado-inicial",children:"Criando um estado inicial"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-py",children:"# Um \"estado\" representa uma poss\xedvel execu\xe7\xe3o do programa\r\n# Entry state = estado no in\xedcio do programa\r\n\r\n# 3.1 Estado b\xe1sico\r\nstate = proj.factory.entry_state()\r\n\r\n# 3.2 Estado com entrada simb\xf3lica via STDIN (teclado)\r\nstate_com_input = proj.factory.entry_state(\r\n    stdin=senha  # Nossa vari\xe1vel simb\xf3lica 'senha'\r\n)\r\n\r\n# 3.3 Estado com argumentos de linha de comando\r\n# Se o programa fosse chamado como: ./programa arg1 arg2\r\nstate_com_args = proj.factory.entry_state(\r\n    args=['./meu_programa', claripy.BVS('arg1', 8*20)],  # argv[1]\r\n    env={}  # Vari\xe1veis de ambiente (vazio por simplicidade)\r\n)\n"})}),"\n",(0,s.jsx)(n.h4,{id:"capturando-coisas-impressas",children:"Capturando coisas impressas"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-py",children:'# state.posix.dumps(N) \u2192 captura a sa\xedda de um "file descriptor"\r\n# Em sistemas Unix/POSIX:\r\n#   0 = stdin  (entrada/input)\r\n#   1 = stdout (sa\xedda normal/output)\r\n#   2 = stderr (sa\xedda de erro/error)\r\n\r\n# Exemplo: capturar o que foi impresso na tela\r\noutput = state.posix.dumps(1)  # Pega tudo que foi para stdout\r\nerror = state.posix.dumps(2)   # Pega tudo que foi para stderr\r\ninput_data = state.posix.dumps(0)  # Pega tudo que foi lido de stdin\r\n\r\n# Durante a execu\xe7\xe3o SIMB\xd3LICA, n\xe3o executamos realmente o programa\r\n# Mas simulamos. O .dumps() captura dados que SERIAM impressos\n'})}),"\n",(0,s.jsx)(n.h4,{id:"encontrando-fun\xe7\xf5es",children:"Encontrando fun\xe7\xf5es"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-py",children:'# An\xe1lise de CFG (Control Flow Graph)\r\ncfg = proj.analyses.CFGFast()\r\n\r\n# Listar todas as fun\xe7\xf5es\r\nfor func_addr, func in cfg.kb.functions.items():\r\n    if func.name:  # S\xf3 fun\xe7\xf5es com nome\r\n        print(f"{func.name}: {hex(func_addr)}")\r\n\r\n# Pegar fun\xe7\xe3o espec\xedfica\r\nmain_func = cfg.kb.functions.function(name=\'main\')\r\nprint(f"\\nMain function:")\r\nprint(f"  Endere\xe7o: {hex(main_func.addr)}")\r\nprint(f"  Tamanho: {main_func.size} bytes")\r\nprint(f"  Blocos b\xe1sicos: {len(main_func.blocks)}")\n'})}),"\n",(0,s.jsx)(n.p,{children:"OBS: CFG (Control Flow Graph) \xe9 um grafo usado internamente que possui todos os caminhos poss\xedveis. A cada IF/WHILE/FOR, gera-se um novo estado poss\xedvel cuja sa\xedda \xe9 capturada pelo angr."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"        [main]\r\n           |\r\n           v\r\n    [scanf input] \r\n           |\r\n           v\r\n    [if (check)]\u2500\u2500\u2500\u2500\u2500\u2510\r\n           |         |\r\n           v         v\r\n   [print Win]  [print Lose]\r\n           |         |\r\n           v         v\r\n          [exit]   [exit]\n"})}),"\n",(0,s.jsx)(n.h4,{id:"constraints-importante",children:"Constraints (Importante)"}),"\n",(0,s.jsx)(n.p,{children:"Podemos adicionar regras (constraints) \xe0s vari\xe1veis simb\xf3licas. Quanto mais constraints usarmos, menos valores s\xe3o poss\xedveis, e mais r\xe1pida fica a busca. Saber direcionar a busca \xe9 extremamente importante, pois para programas mais complexos, o tempo de espera pode ser invi\xe1vel."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-py",children:"# Sem constraints: x pode ser QUALQUER valor\r\nx = claripy.BVS('x', 32)\r\n\r\n# Com constraints: x s\xf3 pode ser certos valores\r\nstate.solver.add(x > 10)    # Constraint 1\r\nstate.solver.add(x < 100)   # Constraint 2\r\nstate.solver.add(x % 2 == 0) # Constraint 3\r\n\r\n# Agora x s\xf3 pode ser: 12, 14, 16, ..., 98\r\n\r\n# Podemos usar m\xfaltiplas constraints de uma vez\r\nstate.solver.add(x > 10, x < 50)  # 10 < x < 50\n"})}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsxs)(n.p,{children:["OBS: compara\xe7\xf5es diretas como ",(0,s.jsx)(n.code,{children:"x > 10"})," podem falhar. Em geral falham apenas para strings e arrays, mas se falhar, use a convers\xe3o abaixo."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"c = claripy.BVV(10, 8) # Converter inteiro 10 para bitVec de 8 bits\r\nstate.solver.add(x > c)\n"})}),"\n",(0,s.jsx)(n.p,{children:"Enquanto BVS = Bit Vector Symbolic (vari\xe1vel desconhecida), BVV = Bit Vector Value (valor conhecido)."}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"As constraints servem para evitar o problema de path explosion. Imagine o seguinte c\xf3digo:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-c",children:'int main() {\r\n    int x;\r\n    scanf("%d", &x);\r\n    \r\n    if (x > 10) {       // Branch 1\r\n        if (x < 20) {   // Branch 2  \r\n            if (x != 15) {  // Branch 3\r\n                if (x % 2 == 0) {  // Branch 4\r\n                    // ... e assim vai\r\n                }\r\n            }\r\n        }\r\n    }\r\n    return 0;\r\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:'Se analisarmos ele sem constraints, cada "if" DOBRA o n\xfamero de estados!'}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"2 ifs \u2192 4 estados"}),"\n",(0,s.jsx)(n.li,{children:"3 ifs \u2192 8 estados"}),"\n",(0,s.jsx)(n.li,{children:"10 ifs \u2192 1,024 estados"}),"\n",(0,s.jsxs)(n.li,{children:["20 ifs \u2192 ",(0,s.jsx)(n.strong,{children:"1,048,576 estados"})," \u2190 MAIS LENTO"]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Mas se usarmos constraints:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-py",children:"# N\xf3s SABEMOS que queremos x que chegue no final\r\nx = claripy.BVS('x', 32)\r\nstate.solver.add(x > 10)    # J\xe1 elimina 50% dos estados!\r\nstate.solver.add(x < 20)    # Elimina mais 50%!\r\nstate.solver.add(x != 15)   # Elimina 1 estado espec\xedfico\r\nstate.solver.add(x % 2 == 0) # S\xf3 pares\r\n\r\n# Agora angr s\xf3 explora caminhos que SATISFAZEM estas condi\xe7\xf5es!\n"})}),"\n",(0,s.jsx)(n.p,{children:"N\xe3o precisamos entender todas as constraints do programa, mais quanto mais conseguirmos extrair do c\xf3digo, melhor para o angr."}),"\n",(0,s.jsx)(n.h5,{id:"constraints-para-strings",children:"Constraints para strings"}),"\n",(0,s.jsxs)(n.p,{children:["Podemos adicionar constraints para strings com ",(0,s.jsx)(n.code,{children:"variavel.get_byte(index)"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-py",children:"# Flag tem formato: CTF{XXXXXXXXXXXXXX}\r\nflag = claripy.BVS('flag', 8 * 30)  # 30 bytes\r\n\r\n# Constraints por \xedndice espec\xedfico:\r\nstate.solver.add(flag.get_byte(0) == ord('C'))   # \xcdndice 0 = 'C'\r\nstate.solver.add(flag.get_byte(1) == ord('T'))   # \xcdndice 1 = 'T'\r\nstate.solver.add(flag.get_byte(2) == ord('F'))   # \xcdndice 2 = 'F'\r\nstate.solver.add(flag.get_byte(3) == ord('{'))   # \xcdndice 3 = '{'\r\nstate.solver.add(flag.get_byte(29) == ord('}'))  # \xcdndice 29 = '}'\r\nstate.solver.add(flag.get_byte(30) == 0)         # \xcdndice 30 = null\r\n\r\n# Limitando para somente caracteres de a-z, A-Z, 0-9\r\nfor i in [4,5,6,7,9,10,11,12,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28]:\r\n    byte = flag.get_byte(i)\r\n    is_alpha_num = claripy.Or(\r\n        claripy.And(byte >= ord('A'), byte <= ord('Z')),\r\n        claripy.And(byte >= ord('a'), byte <= ord('z')),\r\n        claripy.And(byte >= ord('0'), byte <= ord('9'))\r\n    )\r\n    state.solver.add(is_alpha_num)\n"})}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsxs)(n.p,{children:["OBS: ",(0,s.jsx)(n.code,{children:"ord"})," \xe9 uma fun\xe7\xe3o do python que retorna o c\xf3digo (valor inteiro) de um caractere ASCII."]}),"\n"]}),"\n",(0,s.jsx)(n.h5,{id:"constraints-para-arrays",children:"Constraints para arrays"}),"\n",(0,s.jsx)(n.p,{children:"Para arrays simples como lista:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-py",children:"# Array de 10 inteiros (32 bits cada)\r\narray_ints = [claripy.BVS(f'arr_{i}', 32) for i in range(10)]\r\n\r\n# Constraints em \xedndices espec\xedficos:\r\nstate.solver.add(array_ints[0] == 100)       # arr[0] = 100\r\nstate.solver.add(array_ints[1] > array_ints[0])  # arr[1] > arr[0]\n"})}),"\n",(0,s.jsx)(n.p,{children:"Para arrays nativos:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-py",children:"# Array de 10 bytes (80 bits) como UMA vari\xe1vel\r\narray = claripy.BVS('array', 8 * 10)  # 10 bytes \xd7 8 bits\r\n\r\n# Converter inteiro 10 para BitVec de 8 bits\r\nconst = claripy.BVV(10, 8) \r\n\r\n# Constraint no byte espec\xedfico (\xedndice 3)\r\nstate.solver.add(array.get_byte(3) > const)\n"})}),"\n",(0,s.jsx)(n.p,{children:"Para arrays multidimensionais:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-py",children:"# Matriz 3x3\r\nmatriz = [[claripy.BVS(f'matriz_{i}_{j}', 32) for j in range(3)] for i in range(3)]\r\n\r\n# Constraint espec\xedfica:\r\nstate.solver.add(matriz[0][0] == 1)      # canto superior esquerdo\n"})}),"\n",(0,s.jsx)(n.h4,{id:"hook-de-fun\xe7\xf5es",children:"Hook de fun\xe7\xf5es"}),"\n",(0,s.jsxs)(n.p,{children:["Existem fun\xe7\xf5es muito problem\xe1ticas, como ",(0,s.jsx)(n.code,{children:"rand()"}),", ",(0,s.jsx)(n.code,{children:"time()"}),", etc. Elas soltam valores diferentes a todo momento, ent\xe3o \xe9 conveniente adotar um retorno padr\xe3o para elas, permitindo a an\xe1lise."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-py",children:"import angr\r\n\r\n# Hook para fun\xe7\xe3o rand() sempre retornar 42\r\nclass RandHook(angr.SimProcedure):\r\n    def run(self):\r\n        return 42  # Sempre retorna 42\r\n\r\nproj = angr.Project('./programa', auto_load_libs=False)\r\nproj.hook_symbol('rand', RandHook())  # Substitui rand()\n"})}),"\n",(0,s.jsx)(n.h4,{id:"explora\xe7\xe3o-dirigida-por-endere\xe7o-de-mem\xf3ria",children:"Explora\xe7\xe3o dirigida por endere\xe7o de mem\xf3ria"}),"\n",(0,s.jsx)(n.p,{children:"Podemos fazer uma explora\xe7\xe3o buscando chegar em um endere\xe7o de mem\xf3ria espec\xedfico."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-PY",children:'# Come\xe7ar do estado inicial\r\nstate = proj.factory.entry_state()\r\nsimgr = proj.factory.simulation_manager(state)\r\n\r\n# 3. Definir endere\xe7o alvo (onde queremos chegar)\r\n# Suponha que 0x401234 seja o endere\xe7o de "printf("Win!")"\r\ntarget_addr = 0x401234  # Endere\xe7o da string "print Win!"\r\n\r\n# Explorar at\xe9 encontrar um estado nesse endere\xe7o\r\nsimgr.explore(find=target_addr)\r\n\r\n# 5. Verificar resultados\r\nif len(simgr.found) > 0:\r\n    print(f"\u2705 Encontrado {len(simgr.found)} caminho(s) para 0x{target_addr:x}")\r\n    \r\n    # Para cada estado encontrado\r\n    for i, found_state in enumerate(simgr.found):\r\n        print(f"\\n--- Caminho {i+1} ---")\r\n        \r\n        # Podemos obter a entrada que levou at\xe9 l\xe1\r\n        # Supondo que a entrada estava em stdin\r\n        input_data = found_state.posix.dumps(0)  # stdin\r\n        print(f"Entrada: {input_data}")\r\n        \r\n        # Mostrar onde veio\r\n        print(f"Endere\xe7o atual: 0x{found_state.addr:x}")\r\n        \r\nelse:\r\n    print("\u274c Nenhum caminho encontrado para o endere\xe7o alvo")\r\n    print(f"Estados ativos: {simgr.active}")\n'})}),"\n",(0,s.jsx)(n.h4,{id:"erros-e-problemas-comuns",children:"Erros e problemas comuns"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Esquecer ",(0,s.jsx)(n.code,{children:"auto_load_libs=False"})]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-py",children:"proj = angr.Project('./programa')  # Pode travar\r\nproj = angr.Project('./programa', auto_load_libs=False)  # Correto\n"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Vari\xe1vel muito grande"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-py",children:"entrada = claripy.BVS('entrada', 1000*8)  # MUITO LENTO\r\nentrada = claripy.BVS('entrada', 50*8)    # Suficiente para maioria\n"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"N\xe3o limitar explora\xe7\xe3o"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-py",children:"simgr.explore(find=alvo)  # Pode rodar indefinidamente\r\nsimgr.explore(find=alvo, limit=1000)  # Limita estados\n"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Path explosion"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-py",children:"# Programa com MUITOS ifs aninhados\r\nif (x > 10) {\r\n    if (y < 20) {\r\n        if (z == 30) {\r\n            // ... e assim por diante\r\n        }\r\n    }\r\n}\r\n\r\n# angr vai criar 2^n estados!\r\n# Solu\xe7\xf5es:\r\n# 1. Usar .explore(limit=N)\r\n# 2. Usar constraints\r\n# 3. Definir find/avoid espec\xedficos\n"})}),"\n",(0,s.jsx)(n.h4,{id:"exemplo---encontrando-senha",children:"Exemplo - Encontrando senha"}),"\n",(0,s.jsxs)(n.p,{children:["Temos o seguinte programa, e queremos, dado um input, obter o output: ",(0,s.jsx)(n.code,{children:"ACESSO PERMITIDO!\\n"}),". O exemplo abaixo \xe9 simples, mas a l\xf3gica de verifica\xe7\xe3o de senha poderia ser bem mais complexa."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-c",children:'// alvo.c\r\n#include <stdio.h>\r\n#include <string.h>\r\n\r\nint main() {\r\n    char senha[20];\r\n    \r\n    printf("Digite a senha: ");\r\n    scanf("%19s", senha);\r\n    \r\n    if (strcmp(senha, "SECRET") == 0) {\r\n        printf("ACESSO PERMITIDO!\\n");\r\n        return 0;\r\n    } else {\r\n        printf("ACESSO NEGADO!\\n");\r\n        return 1;\r\n    }\r\n}\n'})}),"\n",(0,s.jsxs)(n.p,{children:["Usando o ",(0,s.jsx)(n.code,{children:"angr"})," com ",(0,s.jsx)(n.code,{children:"claripy"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-py",children:'import angr\r\nimport claripy\r\n\r\n# PASSO 1: Carregar o programa\r\nproj = angr.Project(\'./alvo\', auto_load_libs=False)\r\n\r\n# PASSO 2: Criar vari\xe1vel simb\xf3lica para a senha\r\n# "SECRET" tem 6 letras + 1 null byte = 7 bytes\r\nsenha_simbolica = claripy.BVS(\'senha\', 7 * 8)  # 7 bytes\r\n\r\n# PASSO 3: Criar estado inicial com essa entrada\r\nstate = proj.factory.entry_state(stdin=senha_simbolica)\r\n\r\n# PASSO 4: Opcional - adicionar restri\xe7\xf5es (constraints)\r\n# Por exemplo: a senha deve terminar com null byte (\\0)\r\n# state.solver.add(senha_simbolica.get_byte(7) == 0)\r\n\r\n# PASSO 5: Criar gerenciador de simula\xe7\xe3o\r\n# Ele controla m\xfaltiplos "estados" de execu\xe7\xe3o\r\nsimgr = proj.factory.simulation_manager(state)\r\n\r\n# PASSO 6: Definir condi\xe7\xf5es de SUCESSO e FRACASSO\r\ndef sucesso(state):\r\n    """Identifica estados de sucesso"""\r\n    # Pega o que foi impresso na tela (stdout)\r\n    output = state.posix.dumps(1)  # fd 1 = stdout\r\n    \r\n    # Se cont\xe9m "ACESSO PERMITIDO", \xe9 sucesso!\r\n    return b"ACESSO PERMITIDO" in output\r\n\r\ndef fracasso(state):\r\n    """Identifica estados de fracasso"""\r\n    output = state.posix.dumps(1)\r\n    return b"ACESSO NEGADO" in output\r\n\r\n# PASSO 7: Explorar caminhos at\xe9 encontrar sucesso\r\nsimgr.explore(\r\n    find=sucesso,    # Condi\xe7\xe3o para parar (SUCESSO)\r\n    avoid=fracasso   # Caminhos a evitar (FRACASSO)\r\n)\r\n\r\n# PASSO 8: Analisar resultados\r\nif len(simgr.found) > 0:\r\n    print("\ud83c\udf89 SUCESSO! Caminho encontrado")\r\n    \r\n    # Pegar o primeiro estado que levou ao sucesso\r\n    estado_sucesso = simgr.found[0]\r\n    \r\n    # "Resolver" a vari\xe1vel simb\xf3lica (Qual valor concreto satisfaz todas as constraints?)\r\n    senha_concreta = estado_sucesso.solver.eval(\r\n        senha_simbolica,      # Vari\xe1vel a resolver\r\n        cast_to=bytes         # Converter para bytes (em vez de n\xfamero)\r\n    )\r\n    \r\n    # Converter bytes para string (remover null bytes no final)\r\n    senha_string = senha_concreta.decode().split(\'\\x00\')[0]\r\n    \r\n    print(f"\ud83d\udd11 Senha encontrada: \'{senha_string}\'")\r\n    \r\n    # Mostrar mais informa\xe7\xf5es\r\n    print(f"\\n\ud83d\udcca Detalhes:")\r\n    print(f"   Endere\xe7o final: {hex(estado_sucesso.addr)}")\r\n    print(f"   Bytes brutos: {senha_concreta}")\r\n    \r\nelse:\r\n    print("\ud83d\ude1e Nenhuma solu\xe7\xe3o encontrada")\r\n    print(f"Estados ativos: {len(simgr.active)}")\r\n    print(f"Estados evitados: {len(simgr.avoided)}")\n'})}),"\n",(0,s.jsx)(n.h4,{id:"exemplo---minimalista",children:"Exemplo - Minimalista"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-py",children:'import angr\r\nimport claripy\r\n\r\n# 1. Carrega programa\r\np = angr.Project(\'./teste\', auto_load_libs=False)\r\n\r\n# 2. Cria entrada simb\xf3lica (8 bytes)\r\nentrada = claripy.BVS(\'entrada\', 64)  # 64 bits = 8 bytes\r\n\r\n# 3. Estado inicial com entrada\r\ns = p.factory.entry_state(stdin=entrada)\r\n\r\n# 4. Gerenciador de simula\xe7\xe3o\r\nsm = p.factory.simulation_manager(s)\r\n\r\n# 5. Explorar at\xe9 encontrar string "WIN"\r\ndef win_condition(state):\r\n    return b"WIN" in state.posix.dumps(1)\r\n\r\nsm.explore(find=win_condition)\r\n\r\n# 6. Resultado\r\nif sm.found:\r\n    solucao = sm.found[0].solver.eval(entrada, cast_to=bytes)\r\n    print(f"Input vencedor: {solucao}")\n'})}),"\n",(0,s.jsx)(n.h1,{id:"quando-usar-z3-ou-angr",children:"Quando usar Z3 ou angr?"}),"\n",(0,s.jsx)(n.p,{children:"Quando:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"A l\xf3gica \xe9 complexa mas determin\xedstica"}),"\n",(0,s.jsx)(n.li,{children:"Existem muitas restri\xe7\xf5es a serem satisfeitas"}),"\n",(0,s.jsx)(n.li,{children:"A an\xe1lise manual seria muito demorada"}),"\n",(0,s.jsx)(n.li,{children:"Voc\xea precisa gerar inputs espec\xedficos automaticamente"}),"\n"]}),"\n",(0,s.jsx)(n.h1,{id:"exercicios-desenvolver-melhor",children:"Exercicios (Desenvolver melhor)"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:'// Encontrar input que fa\xe7a x == 42\r\nint main() {\r\n    int x;\r\n    scanf("%d", &x);\r\n    if (x == 42) printf("Win!\\n");\r\n    else printf("Lose\\n");\r\n}\r\n\r\n// Encontrar duas vari\xe1veis\r\nint main() {\r\n    int a, b;\r\n    scanf("%d %d", &a, &b);\r\n    if (a + b == 100 && a * b == 2000) printf("Win!\\n");\r\n}\r\n\r\n// String com condi\xe7\xf5es espec\xedficas\r\nint main() {\r\n    char s[10];\r\n    scanf("%9s", s);\r\n    if (s[0] == \'A\' && s[3] == \'Z\' && strlen(s) == 5) printf("Win!\\n");\r\n}\n'})})]})}function m(r={}){const{wrapper:n}={...(0,i.R)(),...r.components};return n?(0,s.jsx)(n,{...r,children:(0,s.jsx)(c,{...r})}):c(r)}},8453(r,n,e){e.d(n,{R:()=>o,x:()=>d});var a=e(6540);const s={},i=a.createContext(s);function o(r){const n=a.useContext(i);return a.useMemo(function(){return"function"==typeof r?r(n):{...n,...r}},[n,r])}function d(r){let n;return n=r.disableParentContext?"function"==typeof r.components?r.components(s):r.components||s:o(r.components),a.createElement(i.Provider,{value:n},r.children)}}}]);