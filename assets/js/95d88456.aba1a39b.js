"use strict";(globalThis.webpackChunkmanual_pwning_docs=globalThis.webpackChunkmanual_pwning_docs||[]).push([[2716],{3183(e,n,a){a.r(n),a.d(n,{assets:()=>i,contentTitle:()=>d,default:()=>h,frontMatter:()=>c,metadata:()=>r,toc:()=>l});const r=JSON.parse('{"id":"extra/call-convention","title":"Conven\xe7\xe3o de chamada de fun\xe7\xf5es","description":"A conven\xe7\xe3o abordada aqui \xe9 a conven\xe7\xe3o de chamada padr\xe3o do System V AMD64 ABI, usado pelo Linux, macOS, BSD, etc. para c\xf3digo em modo usu\xe1rio.","source":"@site/docs/extra/call-convention.mdx","sourceDirName":"extra","slug":"/extra/call-convention","permalink":"/manual-pwning/docs/extra/call-convention","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"title":"Conven\xe7\xe3o de chamada de fun\xe7\xf5es"},"sidebar":"tutorialSidebar","previous":{"title":"Principais Fun\xe7\xf5es Shellcraft","permalink":"/manual-pwning/docs/extra/shellcraft-li"}}');var o=a(4848),s=a(8453);const c={title:"Conven\xe7\xe3o de chamada de fun\xe7\xf5es"},d=void 0,i={},l=[{value:"Troca de stack frame",id:"troca-de-stack-frame",level:2},{value:"Conven\xe7\xe3o de chamada para 32-bit e 64-bit",id:"conven\xe7\xe3o-de-chamada-para-32-bit-e-64-bit",level:2},{value:"x86 (32-bit)",id:"x86-32-bit",level:3},{value:"x86-64 (64-bit)",id:"x86-64-64-bit",level:3},{value:"Alinhamento de stack",id:"alinhamento-de-stack",level:2}];function t(e){const n={code:"code",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.p,{children:"A conven\xe7\xe3o abordada aqui \xe9 a conven\xe7\xe3o de chamada padr\xe3o do System V AMD64 ABI, usado pelo Linux, macOS, BSD, etc. para c\xf3digo em modo usu\xe1rio."}),"\n",(0,o.jsxs)(n.p,{children:["Imagine que temos uma fun\xe7\xe3o ",(0,o.jsx)(n.code,{children:"funcao(arg1, arg2, arg3,...)"}),". Como a fun\xe7\xe3o obt\xe9m seus par\xe2metros?"]}),"\n",(0,o.jsx)(n.h2,{id:"troca-de-stack-frame",children:"Troca de stack frame"}),"\n",(0,o.jsxs)(n.p,{children:["Lmbre-se que no in\xedcio de toda fun\xe7\xe3o temos a cria\xe7\xe3o de um novo stack frame para a fun\xe7\xe3o com ",(0,o.jsx)(n.code,{children:"push rbp"})," (salva rbp/stack frame antigo) e ",(0,o.jsx)(n.code,{children:"mov RBP, RSP"})," (novo stack frame). Antes do ",(0,o.jsx)(n.code,{children:"push rbp"}),", a instru\xe7\xe3o ",(0,o.jsx)(n.code,{children:"call"})," faz o ",(0,o.jsx)(n.code,{children:"push rip"})," (salva return address) e ",(0,o.jsx)(n.code,{children:"jmp"}),"."]}),"\n",(0,o.jsxs)(n.p,{children:["Assim, ",(0,o.jsx)(n.strong,{children:"antes de come\xe7ar a puxar os par\xe2metros na fun\xe7\xe3o, temos a troca de stack frame"}),"."]}),"\n",(0,o.jsx)(n.h2,{id:"conven\xe7\xe3o-de-chamada-para-32-bit-e-64-bit",children:"Conven\xe7\xe3o de chamada para 32-bit e 64-bit"}),"\n",(0,o.jsx)(n.h3,{id:"x86-32-bit",children:"x86 (32-bit)"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:["Argumentos s\xe3o todos passados na ",(0,o.jsx)(n.strong,{children:"stack"})," (",(0,o.jsx)(n.code,{children:"push arg1; push arg2; ..."}),")"]}),"\n",(0,o.jsxs)(n.li,{children:["Chama-se fun\xe7\xe3o (",(0,o.jsx)(n.code,{children:"call funcao"})," = ",(0,o.jsx)(n.code,{children:"push rip; jmp funcao"}),")"]}),"\n",(0,o.jsxs)(n.li,{children:["Fun\xe7\xe3o cria novo stack frame (",(0,o.jsx)(n.code,{children:"push rbp; mov rbp, rsp"}),")"]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"funcao"})," vai buscar o valor para o primeiro par\xe2metro ap\xf3s o ",(0,o.jsx)(n.code,{children:"return address"})," (depois de criar novo frame). Isso seria aproximadamente ",(0,o.jsx)(n.code,{children:"esp+4"})," (para o stack frame antigo, considerando o endere\xe7o de retorno na stack)"]}),"\n"]}),"\n",(0,o.jsxs)(n.p,{children:["Antes entrar em ",(0,o.jsx)(n.code,{children:"funcao"}),", mas ap\xf3s ",(0,o.jsx)(n.code,{children:"call"}),":"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"ESP   \u2192 endere\xe7o de retorno\r\nESP+4 \u2192 primeiro argumento\r\nESP+8 \u2192 segundo argumento, etc.\n"})}),"\n",(0,o.jsxs)(n.p,{children:["Quando entramos em ",(0,o.jsx)(n.code,{children:"funcao"}),":"]}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:["Novo ESP e EBP (novo stack frame) (",(0,o.jsx)(n.code,{children:"push ebp; mov ebp, esp"}),")"]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"funcao"})," espera encontrar o valor para ",(0,o.jsx)(n.code,{children:"arg1"})," em ",(0,o.jsx)(n.code,{children:"ebp+8"}),", e os outros em seguida"]}),"\n"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"EBP+0   \u2192 RBP antigo\r\nEBP+4   \u2192 endere\xe7o de retorno\r\nESP+8   \u2192 primeiro argumento\r\nESP+12  \u2192 segundo argumento, etc.\n"})}),"\n",(0,o.jsx)(n.h3,{id:"x86-64-64-bit",children:"x86-64 (64-bit)"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"Os primeiros argumentos s\xe3o passados em registradores"}),"\n",(0,o.jsxs)(n.li,{children:["Argumentos excedentes s\xe3o passados na ",(0,o.jsx)(n.strong,{children:"stack"})," (",(0,o.jsx)(n.code,{children:"push arg7; push arg8; ..."}),")"]}),"\n",(0,o.jsxs)(n.li,{children:["Chama-se fun\xe7\xe3o (",(0,o.jsx)(n.code,{children:"call funcao"})," = ",(0,o.jsx)(n.code,{children:"push rip; jmp funcao"}),")"]}),"\n",(0,o.jsxs)(n.li,{children:["Fun\xe7\xe3o cria novo stack frame (",(0,o.jsx)(n.code,{children:"push rbp; mov rbp, rsp"}),")"]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"funcao"})," vai primeiro olhar nos registradores que armazenam par\xe2metros (",(0,o.jsx)(n.code,{children:"RDI"}),", ",(0,o.jsx)(n.code,{children:"RSI"}),", ",(0,o.jsx)(n.code,{children:"RDX"}),", ",(0,o.jsx)(n.code,{children:"RCX"}),", ",(0,o.jsx)(n.code,{children:"R8"}),", ",(0,o.jsx)(n.code,{children:"R9"}),")"]}),"\n",(0,o.jsx)(n.li,{children:"S\xf3 depois busca na stack"}),"\n"]}),"\n",(0,o.jsx)(n.p,{children:"Lembrando a ordem de passagem de argumentos para registradores:"}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"RDI"})," (Endere\xe7o da Format String)"]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"RSI"}),"  (Par\xe2metro 1)"]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"RDX"})," (Par\xe2metro 2)"]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"RCX"})," (...)"]}),"\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.code,{children:"R8"})}),"\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.code,{children:"R9"})}),"\n",(0,o.jsx)(n.li,{children:"Stack (RSP+8, RSP+16, ...)"}),"\n"]}),"\n",(0,o.jsx)(n.h2,{id:"alinhamento-de-stack",children:"Alinhamento de stack"}),"\n",(0,o.jsxs)(n.p,{children:["A stack deve estar alinhada em 16 bytes no momento da chamada call (",(0,o.jsx)(n.code,{children:"rsp % 16 == 0"}),"). Para fun\xe7\xf5es nativas do c\xf3digo isso n\xe3o \xe9 problema, mas para ataques precisamos ter isso em mente."]})]})}function h(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(t,{...e})}):t(e)}},8453(e,n,a){a.d(n,{R:()=>c,x:()=>d});var r=a(6540);const o={},s=r.createContext(o);function c(e){const n=r.useContext(s);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:c(e.components),r.createElement(s.Provider,{value:n},e.children)}}}]);