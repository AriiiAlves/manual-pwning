"use strict";(globalThis.webpackChunkmanual_pwning_docs=globalThis.webpackChunkmanual_pwning_docs||[]).push([[2864],{1741(e,a,n){n.r(a),n.d(a,{assets:()=>c,contentTitle:()=>t,default:()=>l,frontMatter:()=>i,metadata:()=>o,toc:()=>d});const o=JSON.parse('{"id":"pwning/rop/8-3-stack-pivoting","title":"Stack Pivoting","description":"\xc0s vezes n\xe3o temos espa\xe7o suficiente na stack para colocar os gadgets ROP (stack limitada), ou a stack original est\xe1 protegida.","source":"@site/docs/pwning/rop/8-3-stack-pivoting.mdx","sourceDirName":"pwning/rop","slug":"/pwning/rop/8-3-stack-pivoting","permalink":"/manual-pwning/docs/pwning/rop/8-3-stack-pivoting","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"title":"Stack Pivoting"},"sidebar":"tutorialSidebar","previous":{"title":"Partial Overwrite","permalink":"/manual-pwning/docs/pwning/rop/8-2-partial-overwrite"},"next":{"title":"SIGROP (Sigreturn-Oriented Programming)","permalink":"/manual-pwning/docs/pwning/rop/8-4-sigrop"}}');var r=n(4848),s=n(8453);const i={title:"Stack Pivoting"},t=void 0,c={},d=[{value:"Encontrando a nova stack",id:"encontrando-a-nova-stack",level:2},{value:"Gadgets comuns para pivoting",id:"gadgets-comuns-para-pivoting",level:2}];function p(e){const a={code:"code",h2:"h2",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",...(0,s.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(a.p,{children:"\xc0s vezes n\xe3o temos espa\xe7o suficiente na stack para colocar os gadgets ROP (stack limitada), ou a stack original est\xe1 protegida."}),"\n",(0,r.jsx)(a.p,{children:"A solu\xe7\xe3o para isso \xe9 o stack pivoting: Vamos criar uma nova stack para usarmos os gadgets. Ou seja, mudamos para um lugar maior e mais livre onde temos mais espa\xe7o para trabalhar."}),"\n",(0,r.jsxs)(a.ol,{children:["\n",(0,r.jsxs)(a.li,{children:["Alocamos mem\xf3ria em outro lugar (heap, .data, etc.). Precisamos ",(0,r.jsx)(a.code,{children:"obter o endere\xe7o de uma regi\xe3o de mem\xf3ria control\xe1vel"}),"."]}),"\n",(0,r.jsx)(a.li,{children:"Encadeamos os gadgets na nova stack ([Gadget 1] \u2192 [Gadget 2] \u2192 [Gadget 3] \u2192 ...)"}),"\n",(0,r.jsxs)(a.li,{children:["Usamos um gadget que muda o registrador RSP para nossa nova stack (",(0,r.jsx)(a.code,{children:"mov rsp, rax"})," + ",(0,r.jsx)(a.code,{children:"ret"}),") (stack pivoting!)"]}),"\n",(0,r.jsx)(a.li,{children:"A CPU agora usa nossa nova stack."}),"\n"]}),"\n",(0,r.jsxs)(a.p,{children:["Lembre-se que o ",(0,r.jsx)(a.code,{children:"ret"})," \xe9 uma instru\xe7\xe3o compacta que na verdade executa ",(0,r.jsx)(a.code,{children:"pop rip"}),". E lembre-se que ",(0,r.jsx)(a.code,{children:"pop"})," usa ",(0,r.jsx)(a.code,{children:"rsp"}),' como refer\xeancia para fazer o "pop" um elemento da stack. Assim, o ',(0,r.jsx)(a.code,{children:"pop rip"})," pega o endere\xe7o para o qual ",(0,r.jsx)(a.code,{children:"rsp"})," aponta e coloca no ",(0,r.jsx)(a.code,{children:"rip"}),". Portanto, basta fazer ",(0,r.jsx)(a.code,{children:"mov rsp, rax"})]}),"\n",(0,r.jsx)(a.p,{children:"O Stack Pivoting d\xe1 bypass em ASLR/NX."}),"\n",(0,r.jsxs)(a.p,{children:["Resumindo: ",(0,r.jsx)(a.strong,{children:"Stack Pivoting = Redirecionar RSP/ESP para regi\xe3o controlada + ROP chain pr\xe9-montada"}),"."]}),"\n",(0,r.jsx)(a.h2,{id:"encontrando-a-nova-stack",children:"Encontrando a nova stack"}),"\n",(0,r.jsxs)(a.ol,{children:["\n",(0,r.jsx)(a.li,{children:"Heap (via malloc/free)"}),"\n",(0,r.jsx)(a.li,{children:"Se\xe7\xe3o .data ou .bss"}),"\n",(0,r.jsx)(a.li,{children:"Stack secund\xe1ria (usando vazamento de endere\xe7o)"}),"\n",(0,r.jsx)(a.li,{children:"Mem\xf3ria mapeada (mmap)"}),"\n"]}),"\n",(0,r.jsx)(a.h2,{id:"gadgets-comuns-para-pivoting",children:"Gadgets comuns para pivoting"}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-nasm",children:"\r\n# 1. Movimento direto\r\nmov esp, eax ; ret        # Copia EAX para ESP\r\nxchg esp, eax ; ret       # Troca ESP com EAX\r\n\r\n# 2. Aritm\xe9tico\r\nadd esp, 0x100 ; ret      # Aumenta ESP\r\nsub esp, 0x100 ; ret      # Diminui ESP\r\n\r\n# 3. Indireto\r\npush rax ; pop rsp ; ret  # Move RAX para RSP via push/pop\n"})}),"\n",(0,r.jsxs)(a.p,{children:["Para o stack pivoting com ",(0,r.jsx)(a.code,{children:"rax"})," funcionar, precisamos de um gadget ",(0,r.jsx)(a.code,{children:"pop_rax"})," para colocar o endere\xe7o desejado em ",(0,r.jsx)(a.code,{children:"rax"}),"."]}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-nasm",children:"[Buffer overflow...]\r\n[pop_rax_gadget]     \u2190 RIP vai aqui primeiro (return address)\r\n[&nova_stack]        # Valor para RAX\r\n[mov_rsp_rax_gadget] # Gadget que faz pivot\n"})})]})}function l(e={}){const{wrapper:a}={...(0,s.R)(),...e.components};return a?(0,r.jsx)(a,{...e,children:(0,r.jsx)(p,{...e})}):p(e)}},8453(e,a,n){n.d(a,{R:()=>i,x:()=>t});var o=n(6540);const r={},s=o.createContext(r);function i(e){const a=o.useContext(s);return o.useMemo(function(){return"function"==typeof e?e(a):{...a,...e}},[a,e])}function t(e){let a;return a=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:i(e.components),o.createElement(s.Provider,{value:a},e.children)}}}]);