<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-pwning/bof/2-2-bof-callfunction" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.2">
<title data-rh="true">Buffer Overflow - Return Address | CatchTheFox</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://ariiialves.github.io/manual-pwning/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://ariiialves.github.io/manual-pwning/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://ariiialves.github.io/manual-pwning/docs/pwning/bof/2-2-bof-callfunction"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Buffer Overflow - Return Address | CatchTheFox"><meta data-rh="true" name="description" content="Na stack, vimos que há um endereço de retorno. Em x64, esse endereço de retorno fica em rbp+0x8. Em x32, esse endereço de retorno fica em ebp+0x4."><meta data-rh="true" property="og:description" content="Na stack, vimos que há um endereço de retorno. Em x64, esse endereço de retorno fica em rbp+0x8. Em x32, esse endereço de retorno fica em ebp+0x4."><link data-rh="true" rel="icon" href="/manual-pwning/img/logo.ico"><link data-rh="true" rel="canonical" href="https://ariiialves.github.io/manual-pwning/docs/pwning/bof/2-2-bof-callfunction"><link data-rh="true" rel="alternate" href="https://ariiialves.github.io/manual-pwning/docs/pwning/bof/2-2-bof-callfunction" hreflang="en"><link data-rh="true" rel="alternate" href="https://ariiialves.github.io/manual-pwning/docs/pwning/bof/2-2-bof-callfunction" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Pwning","item":"https://ariiialves.github.io/manual-pwning/docs/pwning/beginning"},{"@type":"ListItem","position":2,"name":"Buffer Overflow","item":"https://ariiialves.github.io/manual-pwning/docs/pwning/bof/2-0-bof"},{"@type":"ListItem","position":3,"name":"Buffer Overflow - Return Address","item":"https://ariiialves.github.io/manual-pwning/docs/pwning/bof/2-2-bof-callfunction"}]}</script><link rel="alternate" type="application/rss+xml" href="/manual-pwning/blog/rss.xml" title="CatchTheFox RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/manual-pwning/blog/atom.xml" title="CatchTheFox Atom Feed"><link rel="stylesheet" href="/manual-pwning/assets/css/styles.9a6cb60f.css">
<script src="/manual-pwning/assets/js/runtime~main.b571a340.js" defer="defer"></script>
<script src="/manual-pwning/assets/js/main.fcfdbe72.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")),document.documentElement.setAttribute("data-theme-choice",t||"system")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/manual-pwning/img/logo.svg"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/manual-pwning/"><div class="navbar__logo"><img src="/manual-pwning/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/manual-pwning/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">CatchTheFox</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/manual-pwning/docs/intro">HandBook</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/ariiialves/manual-pwning" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/manual-pwning/docs/intro"><span title="Bem vindo" class="linkLabel_WmDU">Bem vindo</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/manual-pwning/docs/introduction/beginning"><span title="Introdução" class="categoryLinkLabel_W154">Introdução</span></a><button aria-label="Expand sidebar category &#x27;Introdução&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--active" href="/manual-pwning/docs/pwning/beginning"><span title="Pwning" class="categoryLinkLabel_W154">Pwning</span></a><button aria-label="Collapse sidebar category &#x27;Pwning&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/manual-pwning/docs/pwning/1-1-protections"><span title="Proteções de binários" class="linkLabel_WmDU">Proteções de binários</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--active" tabindex="0" href="/manual-pwning/docs/pwning/bof/2-0-bof"><span title="Buffer Overflow" class="categoryLinkLabel_W154">Buffer Overflow</span></a><button aria-label="Collapse sidebar category &#x27;Buffer Overflow&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/manual-pwning/docs/pwning/bof/2-1-bof-variables"><span title="Buffer Overflow - Variáveis" class="linkLabel_WmDU">Buffer Overflow - Variáveis</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/manual-pwning/docs/pwning/bof/2-2-bof-callfunction"><span title="Buffer Overflow - Return Address" class="linkLabel_WmDU">Buffer Overflow - Return Address</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/manual-pwning/docs/pwning/bof/2-3-bof-shellcode"><span title="Buffer Overflow - Shellcode" class="linkLabel_WmDU">Buffer Overflow - Shellcode</span></a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/manual-pwning/docs/pwning/format-strings"><span title="Format Strings" class="linkLabel_WmDU">Format Strings</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/manual-pwning/docs/pwning/array-indexing"><span title="Array indexing" class="linkLabel_WmDU">Array indexing</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/manual-pwning/docs/pwning/integer-overflow"><span title="Integer Overflow" class="linkLabel_WmDU">Integer Overflow</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/manual-pwning/docs/pwning/bad-seed"><span title="Bad Seed" class="linkLabel_WmDU">Bad Seed</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/manual-pwning/docs/pwning/z3"><span title="Z3 &amp; Symbolic Execution (angr)" class="linkLabel_WmDU">Z3 &amp; Symbolic Execution (angr)</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" tabindex="0" href="/manual-pwning/docs/pwning/rop/8-1-rop"><span title="ROP (Return-Oriented Programming)" class="categoryLinkLabel_W154">ROP (Return-Oriented Programming)</span></a><button aria-label="Expand sidebar category &#x27;ROP (Return-Oriented Programming)&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/manual-pwning/docs/fast-food/beginning"><span title="Fast Food" class="categoryLinkLabel_W154">Fast Food</span></a><button aria-label="Expand sidebar category &#x27;Fast Food&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/manual-pwning/docs/extra/intro"><span title="Material extra" class="categoryLinkLabel_W154">Material extra</span></a><button aria-label="Expand sidebar category &#x27;Material extra&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/manual-pwning/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/manual-pwning/docs/pwning/beginning"><span>Pwning</span></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/manual-pwning/docs/pwning/bof/2-0-bof"><span>Buffer Overflow</span></a></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Buffer Overflow - Return Address</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Buffer Overflow - Return Address</h1></header><p>Na stack, vimos que há um endereço de retorno. Em <code>x64</code>, esse endereço de retorno fica em <code>rbp+0x8</code>. Em <code>x32</code>, esse endereço de retorno fica em <code>ebp+0x4</code>.</p>
<p>Sempre que uma função chega ao final, ela chama a instrução <code>ret</code>, que desempilha esse endereço de retorno, extrai o endereço que está ali guardado, e atribui ao <code>rip</code>, de modo que o programa começa a ler instruções a partir daquele endereço.</p>
<p>Podemos utilizar Buffer Overflow para <strong>sobrescrever esse endereço de retorno e ir para o lugar que quisermos no código</strong>. Sim, podemos chamar qualquer função, mesmo que ela nunca seja chamada no código (ela só precisa existir).</p>
<p>Para fazer um Buffer Overflow Return Address:</p>
<ol>
<li class="">Verifique informações do arquivo com <code>file arquivo</code></li>
<li class="">Abra o programa no Ghidra ou Debugger</li>
<li class=""><strong>Calcule a distância entre o início do input e do endereço de retorno</strong> <code>rbp+0x8</code> (x64) ou <code>ebp+0x4</code> (x32)<!-- -->
<ol>
<li class="">Ex: Se a variável está em <code>rbp-0x10</code>, a distância é <code>0x10 + 0x8 = 0x18</code>.</li>
</ol>
</li>
<li class="">Em uma string, coloque caracteres para preencher essa distância. Ao final, <strong>adicione o endereço de algum lugar do programa</strong>.</li>
</ol>
<p>Para obter endereços, é recomendável <strong>usar o Ghidra para explorar outras funções que podem existir no arquivo</strong>. Mas há um porém. Existe uma segurança implementada por padrão que é a <strong>randomização de memória</strong>. Toda vez que um programa roda, essa segurança pega endereços aleatórios de memória RAM. Assim, mesmo que você tente um endereço que viu no Ghidra, não irá funcionar, pois outro endereço é que está ativo.</p>
<p>Para vencer esse obstáculo, você teria que vazar um endereço de memória, como vimos que pode ser feito tirando o \0 do fim da string. Mas isso é muito mais limitado do que navegar pelo Ghidra e achar a função com o endereço certinho.</p>
<p>Nesses desafios, essa proteção está desativada, e você pode apenas copiar e colar os endereços. Mais adiante abordaremos sobre isso.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="cuidado-ao-sobrescrever-return-address-desalinhamento-de-stack">Cuidado ao sobrescrever Return Address: Desalinhamento de Stack<a href="#cuidado-ao-sobrescrever-return-address-desalinhamento-de-stack" class="hash-link" aria-label="Direct link to Cuidado ao sobrescrever Return Address: Desalinhamento de Stack" title="Direct link to Cuidado ao sobrescrever Return Address: Desalinhamento de Stack" translate="no">​</a></h2>
<p>Existem algumas funções importantes que utilizam instruções que exigem que a Stack esteja alinhada, como, por exemplo, a função <code>system(&quot;./bin/sh&quot;)</code>. Se seu objetivo for chamar uma função que tenha essa função dentro, o programa vai resultar em falha de segmentação.</p>
<p>Para <code>x64</code>, a stack deve ter o tamanho sempre de um múltiplo de <code>16 bytes</code> antes de uma chamada de função <code>call</code>. Para <code>x86</code>, não há requisito rígido pré-chamada.</p>
<p>Em particular, instruções SSE exigem <code>[rsp] % 16 == 0</code></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">; Instrução SSE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">movaps xmm0, [rsp]    ; ⚠️ CRASH se [rsp] não for múltiplo de 16</span><br></span></code></pre></div></div>
<p>Vamos verificar alinhamento de stack para <code>x64</code>, onde realmente isso pode causar problemas.</p>
<p>Se não estivéssemos fazendo o BOF para chamar uma função, o programa seguiria um padrão de instruções:</p>
<ul>
<li class=""><code>call funcao</code> - <code>PUSH RIP</code> (<code>RSP = RSP - 8</code>) e <code>JMP 0xfuncaoaddr</code> (+8 bytes na stack) // <strong>Desalinha</strong> (8 bytes)</li>
<li class=""><code>inicio_funcao</code> - <code>PUSH RBP</code> (<code>RSP = RSP - 8</code>) (+8 bytes na stack) // <strong>Alinha</strong> (16 bytes)</li>
</ul>
<p>Isso resulta em uma stack alinhada.</p>
<p>Mas como estamos sobrescrevendo o Return Address para irmos ao lugar que quisermos, não existe call, e sim uma modificação do que se faz após <code>leave</code> e <code>ret</code> na função original (<code>main</code>). Segue o fluxo:</p>
<ul>
<li class=""><code>leave</code> - <code>MOV RSP, RBP</code>; <code>POP RBP</code> (<code>RSP = RSP + 8</code>) (-8 bytes na stack) // <strong>Desalinha</strong> (-8 bytes)</li>
<li class=""><code>ret</code> - <code>POP RIP</code> (<code>RSP = RSP + 8</code>) (-8 bytes na stack) // <strong>Alinha</strong> (-16 bytes)</li>
<li class=""><code>inicio_funcao</code> - <code>PUSH RBP</code> (<code>RSP = RSP - 8</code>) (+8 bytes na stack) // <strong>Desalinha</strong> (-8 bytes)</li>
</ul>
<p>Isso vai resultar em <strong>SEGSV (Segmentation Fault)</strong>, e o programa vai crashar.</p>
<p><strong>Como evitar desalinhamento de stack</strong>? Há duas maneiras.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="1---evitando-push-rbp">1° - Evitando PUSH RBP<a href="#1---evitando-push-rbp" class="hash-link" aria-label="Direct link to 1° - Evitando PUSH RBP" title="Direct link to 1° - Evitando PUSH RBP" translate="no">​</a></h3>
<p>Suponha que a função para a qual queremos pular está em <code>0x00000001</code>. A instrução PUSH RBP ocupa 1 byte de memória. Portanto, para pular para a próxima, basta usar o endereço <code>0x00000002</code>.</p>
<div class="language-py codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-py codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">target_address </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x401234</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># Pula o push rbp</span><br></span></code></pre></div></div>
<p>Ou você pode verificar o endereço da próxima instrução ao PUSH RBP no decompilador ou gdb.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="2---rop-com-ret">2° - ROP com ret<a href="#2---rop-com-ret" class="hash-link" aria-label="Direct link to 2° - ROP com ret" title="Direct link to 2° - ROP com ret" translate="no">​</a></h3>
<p>Essa técnica é mais confiável e robusta. <strong><a class="" href="/manual-pwning/docs/pwning/rop/8-1-rop">ROP (Return Oriented Programming)</a> é uma técnica de exploração que usa pedaços de códigos já existentes no programa (gadgets) para executar código malicioso</strong>.</p>
<p>Basicamente, vamos <strong>achar o endereço na memória de uma instrução</strong> <code>ret</code>, um <strong>gadget</strong>. Isso só é possível <strong>se a proteção PIE/ASLR não estiver ativada</strong> (randomização de memória),</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="buscando-gadget">Buscando gadget<a href="#buscando-gadget" class="hash-link" aria-label="Direct link to Buscando gadget" title="Direct link to Buscando gadget" translate="no">​</a></h4>
<p>Podemos usar o comando Linux (deve ser instalado) <code>ROPgadget</code>: <code>ROPgadget -- binary meu_programa | grep &quot;ret&quot;</code>.</p>
<p>Ou podemos usar <strong>pwntools</strong>:</p>
<div class="language-py codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-py codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> pwn </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">elf </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ELF</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;./vuln&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rop </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ROP</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">elf</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Encontra gadgets ret</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ret_gadgets </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> rop</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">find_gadget</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;ret&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;Ret gadget: </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation builtin">hex</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">(</span><span class="token string-interpolation interpolation">ret_gadgets</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">.</span><span class="token string-interpolation interpolation">address</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">)</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Imprime endereço do gadget</span><br></span></code></pre></div></div>
<p>Assim, podemos montar nosso payload.</p>
<p>Mas, antes de usarmos esse <code>ret</code>, vamos entender por que ele funciona.</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="por-que-ret">Por que <code>ret</code>?<a href="#por-que-ret" class="hash-link" aria-label="Direct link to por-que-ret" title="Direct link to por-que-ret" translate="no">​</a></h4>
<p>No <strong>fim de uma função qualquer</strong>, sempre teremos as instruções:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">0x0000000000401208 &lt;+124&gt;:   leave</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x0000000000401209 &lt;+125&gt;:   ret</span><br></span></code></pre></div></div>
<ul>
<li class=""><code>leave</code> - Comando compacto:<!-- -->
<ul>
<li class=""><code>MOV RSP, RBP</code> - <code>RBP</code> é copiado para <code>RSP</code>. Isso destrói o stack frame da função, descartando todas as variáveis locais. (agora, o próximo da stack é o <code>RBP</code> antigo)</li>
<li class=""><code>POP RBP</code> - O valor no topo da pilha (<code>RBP</code> antigo) é desempilhado para o registrador <code>RBP</code>. Isso faz o stack frame &quot;voltar para trás&quot;. (agora, o próximo da stack é o <code>return address</code>)</li>
</ul>
</li>
<li class=""><code>ret</code> - Comando compacto:<!-- -->
<ul>
<li class=""><code>POP RIP</code> - O valor no topo da pilha (apontado pelo <code>RSP</code>) agora é <code>RBP+8</code>, o <code>return address</code> que tentamos sobrescrever. Como <code>RIP</code> é o registrador que indica a instrução atual ativa, estamos fazendo o programa &quot;pular&quot; para um endereço de memória salvo em <code>RBP+8</code>.</li>
</ul>
</li>
</ul>
<p>Esse é o fluxo normal de sair de uma função e ir para outra. Isso deixa a stack alinhada. O efeito que o <code>ret</code> tem é de <strong>tirar 8 bytes da stack</strong>.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">No assembly:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[RBP-0x20] = AAAA...          (bytes de padding)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[RBP+0x00] = RBP antigo        (8 bytes) &lt;- RSP = RBP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[RBP+0x08] = RET gadget        ← RIP vai aqui</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">No RIP:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x00000000ff ret -&gt; Efeito: POP RIP (tira 8 bytes da stack)</span><br></span></code></pre></div></div>
<p>Se sobrescrevemos o <code>return address</code> com um endereço de um local do código com <code>ret</code>, teremos o seguinte fluxo:</p>
<ul>
<li class=""><code>leave</code> - Comando compacto:<!-- -->
<ul>
<li class=""><code>MOV RSP, RBP</code> - <code>RBP</code> é copiado para <code>RSP</code>. Isso destrói o stack frame da função, descartando todas as variáveis locais. (agora, o próximo da stack é o <code>RBP</code> antigo)</li>
<li class=""><code>POP RBP</code> - O valor no topo da pilha (<code>RBP</code> antigo) é desempilhado para o registrador <code>RBP</code>. Isso faz o stack frame &quot;voltar para trás&quot;. (agora, o próximo da stack é o <code>return address</code>)</li>
</ul>
</li>
<li class=""><code>ret</code> - Comando compacto:<!-- -->
<ul>
<li class=""><code>POP RIP</code> - O valor no topo da pilha (apontado pelo <code>RSP</code>) agora é <code>RBP+0x8</code>, o <code>return address</code> que contém o ROP. Pulamos para um endereço de memória salvo em <code>RBP+8</code>.</li>
</ul>
</li>
<li class="">Somos levados a uma instrução <code>ret</code> novamente, que interage com a stack.</li>
<li class=""><code>ret</code> - Comando compacto:<!-- -->
<ul>
<li class=""><code>POP RIP</code> - O valor no topo da pilha (apontado pelo <code>RSP</code>) agora é <code>RBP+0x10</code>, o <code>return address</code> que tentamos sobrescrever. Pulamos para um endereço de memória salvo em <code>RBP+0x10</code>, que é nossa função.</li>
</ul>
</li>
</ul>
<p>Assim, teremos a seguinte stack após um overflow:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[RBP-0x20] = AAAA...          (bytes de padding)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[RBP+0x00] = RBP antigo        (8 bytes) </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[RBP+0x08] = RET gadget        ← RIP vai aqui primeiro!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[RBP+0x10] = Função alvo       ← RIP vai aqui depois!</span><br></span></code></pre></div></div>
<p>E:</p>
<ul>
<li class=""><code>leave</code> - <code>MOV RSP, RBP</code>; <code>POP RBP</code> (<code>RSP = RSP + 8</code>) (-8 bytes na stack) // <strong>Desalinha</strong> (-8 bytes)</li>
<li class=""><code>ret</code> - <code>POP RIP</code> (<code>RSP = RSP + 8</code>) (-8 bytes na stack) // <strong>Alinha</strong> (-16 bytes)</li>
<li class="">Agora, o <code>ret</code> leva a um lugar que não era para levar (manipulado por nós)</li>
<li class=""><code>ret</code> - <code>POP RIP</code> (<code>RSP = RSP + 16</code>) (-8 bytes na stack) // <strong>Alinha</strong> (-24 bytes)</li>
<li class=""><code>inicio_funcao</code> - <code>PUSH RBP</code> (<code>RSP = RSP - 8</code>) (+8 bytes na stack) // <strong>Desalinha</strong> (-16 bytes)</li>
</ul>
<p>Veja, alinhamos com 16 bytes agora.</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="código-em-pwntools">Código em pwntools<a href="#código-em-pwntools" class="hash-link" aria-label="Direct link to Código em pwntools" title="Direct link to Código em pwntools" translate="no">​</a></h4>
<div class="language-py codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-py codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Acha gadget</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">elf </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ELF</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;./vuln&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rop </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ROP</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">elf</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ret </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> rop</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">find_gadget</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;ret&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Alinha com ret e entra na função</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">payload </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&#x27;A&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">40</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">payload </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ret</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">payload </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">func_addr</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div></div></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/manual-pwning/docs/pwning/bof/2-1-bof-variables"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Buffer Overflow - Variáveis</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/manual-pwning/docs/pwning/bof/2-3-bof-shellcode"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Buffer Overflow - Shellcode</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#cuidado-ao-sobrescrever-return-address-desalinhamento-de-stack" class="table-of-contents__link toc-highlight">Cuidado ao sobrescrever Return Address: Desalinhamento de Stack</a><ul><li><a href="#1---evitando-push-rbp" class="table-of-contents__link toc-highlight">1° - Evitando PUSH RBP</a></li><li><a href="#2---rop-com-ret" class="table-of-contents__link toc-highlight">2° - ROP com ret</a><ul><li><a href="#buscando-gadget" class="table-of-contents__link toc-highlight">Buscando gadget</a></li><li><a href="#por-que-ret" class="table-of-contents__link toc-highlight">Por que <code>ret</code>?</a></li><li><a href="#código-em-pwntools" class="table-of-contents__link toc-highlight">Código em pwntools</a></li></ul></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Aprenda</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/manual-pwning/docs/intro">HandBook</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Comunidade</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://discord.gg/pFSq368vu7" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Mais</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/ariiialves/manual-pwning" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div></div></footer></div>
</body>
</html>